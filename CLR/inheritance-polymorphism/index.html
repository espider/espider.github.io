<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>CLR运行时细节 - 继承多态的实现 | espider.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="CLR运行时细节 - 继承多态的实现 inheritance Polymorphism Virtual Dispatch">
<meta property="og:type" content="article">
<meta property="og:title" content="CLR运行时细节 - 继承多态的实现">
<meta property="og:url" content="http://espider.github.io/CLR/inheritance-polymorphism/index.html">
<meta property="og:site_name" content="espider.github.io">
<meta property="og:description" content="CLR运行时细节 - 继承多态的实现 inheritance Polymorphism Virtual Dispatch">
<meta property="og:image" content="http://espider.github.io/img/02PM/BaseClass.png">
<meta property="og:image" content="http://espider.github.io/img/02PM/BrotherClass.png">
<meta property="og:image" content="http://espider.github.io/img/02PM/DerivedOfBrotherClass.png">
<meta property="og:updated_time" content="2016-10-23T09:48:18.788Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CLR运行时细节 - 继承多态的实现">
<meta name="twitter:description" content="CLR运行时细节 - 继承多态的实现 inheritance Polymorphism Virtual Dispatch">
<meta name="twitter:image" content="http://espider.github.io/img/02PM/BaseClass.png">
  
    <link rel="alternative" href="/atom.xml" title="espider.github.io" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/logo.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">chengl</a></h1>
		</hgroup>

		
		<p class="header-subtitle">blog for CLR details</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">@我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
		        
					<a class="rss" target="_blank" href="#" title="rss">rss</a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">chengl</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/img/logo.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">chengl</h1>
			</hgroup>
			
			<p class="header-subtitle">blog for CLR details</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-inheritance-polymorphism" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CLR运行时细节 - 继承多态的实现
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- # CLR运行时细节 - 继承多态的实现 Inheritance Polymorphism Virtual Dispatch -->
<h2 id=""><a href="#" class="headerlink" title=" "></a> </h2><p>关于多态不多解释了,在运行时决定和调用具体的实现,是面向对象的基础 设计模式的基础.<br>准备把继承多态和接口多态分开,因为从CLR实现的角度继承多态相比于接口多态要简单得多,也更容易理解,本篇只讨论继承多态, .NET Framework 2.0 和 4.0 这两个版本在实现上稍微有点区别(这里先忽略方法Jit编译的过程,只关注实现的方式).</p>
<p><strong>废话不多,先看代码: C# Polymorphism01.cs</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Runtime.CompilerServices;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Program</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"Polymorphism01 demo"</span>);</div><div class="line"></div><div class="line">		BaseClass bc = <span class="keyword">new</span> BaseClass();</div><div class="line">		BaseClass bc1 = <span class="keyword">new</span> ChlidClass();</div><div class="line">		BaseClass bc2 = <span class="keyword">new</span> BrotherClass();</div><div class="line">		BaseClass bc3 = <span class="keyword">new</span> DerivedOfBrotherClass();</div><div class="line">		BrotherClass bc4 = <span class="keyword">new</span> DerivedOfBrotherClass();</div><div class="line">		</div><div class="line">		bc.VirtualFun1();</div><div class="line">		bc1.VirtualFun1();</div><div class="line">		bc2.VirtualFun1();</div><div class="line">		bc3.VirtualFun1();</div><div class="line">		bc3.VirtualFun2();</div><div class="line">		bc4.VirtualFun3();</div><div class="line">		</div><div class="line">		Console.ReadLine();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> BaseClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BaseClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BaseClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> ChlidClass : BaseClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"ChlidClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"ChlidClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> BrotherClass : BaseClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BrotherClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BrotherClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">VirtualFun3</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BrotherClass VirtualFun3"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> DerivedOfBrotherClass : BrotherClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"DerivedOfBrotherClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"DerivedOfBrotherClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun3</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"DerivedOfBrotherClass VirtualFun3"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>编译代码 先用 .Net Framework 2.0 编译:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">%windir%\Microsoft.NET\Framework\v2.0.50727\csc.exe /debug /target:exe /out:e:\temp\Polymorphism01_2.0.exe e:\temp\Polymorphism01.cs</div><div class="line">pause</div></pre></td></tr></table></figure>
</li>
<li><p>运行 Polymorphism01_2.0.exe </p>
</li>
<li><p>启动windbg 附加进程 加载SOS </p>
</li>
<li><p>查找对应的模块：<br><code>!Name2EE *!Polymorphism01_2.0.exe</code></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !Name2EE *!Polymorphism01_2.0.exe</div><div class="line">Module: 790c1000 (mscorlib.dll)</div><div class="line">--------------------------------------</div><div class="line">Module: 00af2c5c (Polymorphism01_2.0.exe)</div></pre></td></tr></table></figure>
<ul>
<li><p>根据模块查找方法表:<br><code>!DumpModule -mt 00af2c5c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !DumpModule -mt 00af2c5c</div><div class="line">Name: E:\temp\Polymorphism01_2.0.exe</div><div class="line">Attributes: PEFile </div><div class="line">Assembly: 00167720</div><div class="line">LoaderHeap: 00000000</div><div class="line">TypeDefToMethodTableMap: 00af00c0</div><div class="line">TypeRefToMethodTableMap: 00af00dc</div><div class="line">MethodDefToDescMap: 00af0100</div><div class="line">FieldDefToDescMap: 00af0144</div><div class="line">MemberRefToDescMap: 00af0148</div><div class="line">FileReferencesMap: 00af016c</div><div class="line">AssemblyReferencesMap: 00af0170</div><div class="line">MetaData start address: 00402170 (1756 bytes)</div><div class="line"></div><div class="line">Types defined in this module</div><div class="line"></div><div class="line">      MT    TypeDef Name</div><div class="line">------------------------------------------------------------------------------</div><div class="line">00af302c 0x02000002 Program</div><div class="line">00af3098 0x02000003 BaseClass</div><div class="line">00af310c 0x02000004 ChlidClass</div><div class="line">00af3188 0x02000005 BrotherClass</div><div class="line">00af3208 0x02000006 DerivedOfBrotherClass</div><div class="line"></div><div class="line">Types referenced in this module</div><div class="line"></div><div class="line">      MT    TypeRef Name</div><div class="line">------------------------------------------------------------------------------</div><div class="line">793308f8 0x01000001 System.Object</div><div class="line">79334648 0x01000006 System.Console</div></pre></td></tr></table></figure>
</li>
<li><p>先分别看下 BaseClass BrotherClass DerivedOfBrotherClass 这3个继承关系类的方法表(MethodTable)</p>
</li>
</ul>
<p><img src="/img/02PM/BaseClass.png" alt="" title="BaseClass MethodTable"></p>
<p><img src="/img/02PM/BrotherClass.png" alt="" title="BrotherClass MethodTable"></p>
<p><img src="/img/02PM/DerivedOfBrotherClass.png" alt="" title="DerivedOfBrotherClass MethodTable"></p>
<ul>
<li><strong>可以看到第一个虚方法(ToString)的入口都是在方法表偏移28h的位置,其顺序是先父类,再子类,这样的安排让所有同一个家族(继承关系)的类型继承虚方法的顺序是一样的,并且偏移量是一样的,所有的类型(除了接口类型)的父类都是(或者间接是)System.Object,所以前4个虚方法肯定是Object里的4个虚方法(ToString Equals GetHashCode Finalize)</strong>  </li>
<li><p>通过Program 的方法表(MethodTable)找到Main方法的入口地址:<br><code>!DumpMT -md 00af302c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !DumpMT -md 00af302c</div><div class="line">EEClass: 00af12f4</div><div class="line">Module: 00af2c5c</div><div class="line">Name: Program</div><div class="line">mdToken: 02000002  (E:\temp\Polymorphism01_2.0.exe)</div><div class="line">BaseSize: 0xc</div><div class="line">ComponentSize: 0x0</div><div class="line">Number of IFaces in IFaceMap: 0</div><div class="line">Slots in VTable: 6</div><div class="line">--------------------------------------</div><div class="line">MethodDesc Table</div><div class="line">   Entry MethodDesc      JIT Name</div><div class="line">79286aa0   79104960   PreJIT System.Object.ToString()</div><div class="line">79286ac0   79104968   PreJIT System.Object.Equals(System.Object)</div><div class="line">79286b30   79104998   PreJIT System.Object.GetHashCode()</div><div class="line">792f76d0   791049bc   PreJIT System.Object.Finalize()</div><div class="line">00afc015   00af3024     NONE Program..ctor()</div><div class="line">01010070   00af3018      JIT Program.Main(System.String[])</div></pre></td></tr></table></figure>
</li>
<li><p>Main方法已经Jit编译,看看被编译成啥样子:<br><code>!u 01010070</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !u 01010070</div><div class="line">Normal JIT generated code</div><div class="line">Program.Main(System.String[])</div><div class="line">Begin 01010070, size 10a</div><div class="line">&gt;&gt;&gt; 01010070 55              push    ebp</div><div class="line">01010071 8bec            mov     ebp,esp</div><div class="line">01010073 83ec2c          sub     esp,2Ch</div><div class="line">01010076 894dfc          mov     dword ptr [ebp-4],ecx</div><div class="line">01010079 833d142eaf0000  cmp     dword ptr ds:[0AF2E14h],0</div><div class="line">01010080 7405            je      01010087</div><div class="line">01010082 e832ff0d79      call    mscorwks!JIT_DbgIsJustMyCode (7a0effb9)</div><div class="line">01010087 33d2            xor     edx,edx</div><div class="line">01010089 8955ec          mov     dword ptr [ebp-14h],edx</div><div class="line">0101008c 33d2            xor     edx,edx</div><div class="line">0101008e 8955f0          mov     dword ptr [ebp-10h],edx</div><div class="line">01010091 33d2            xor     edx,edx</div><div class="line">01010093 8955f4          mov     dword ptr [ebp-0Ch],edx</div><div class="line">01010096 33d2            xor     edx,edx</div><div class="line">01010098 8955f8          mov     dword ptr [ebp-8],edx</div><div class="line">0101009b 33d2            xor     edx,edx</div><div class="line">0101009d 8955e8          mov     dword ptr [ebp-18h],edx</div><div class="line">010100a0 90              nop</div><div class="line">010100a1 8b0d30204202    mov     ecx,dword ptr ds:[2422030h] (&quot;Polymorphism01 demo&quot;)</div><div class="line">*** WARNING: Unable to verify checksum for C:\WINDOWS\assembly\NativeImages_v2.0.50727_32\mscorlib\b14359470744c840c59fbe4e58034fd6\mscorlib.ni.dll</div><div class="line">010100a7 e8b0457878      call    mscorlib_ni+0x6d465c (7979465c) (System.Console.WriteLine(System.String), mdToken: 060007c8)</div><div class="line">010100ac 90              nop</div><div class="line">010100ad b99830af00      mov     ecx,0AF3098h (MT: BaseClass)</div><div class="line">010100b2 e8651fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">010100b7 8945e4          mov     dword ptr [ebp-1Ch],eax</div><div class="line">010100ba 8b4de4          mov     ecx,dword ptr [ebp-1Ch]</div><div class="line">010100bd ff15d830af00    call    dword ptr ds:[0AF30D8h] (BaseClass..ctor(), mdToken: 06000005)</div><div class="line">010100c3 8b45e4          mov     eax,dword ptr [ebp-1Ch]</div><div class="line">010100c6 8945f8          mov     dword ptr [ebp-8],eax</div><div class="line">010100c9 b90c31af00      mov     ecx,0AF310Ch (MT: ChlidClass)</div><div class="line">010100ce e8491fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">010100d3 8945e0          mov     dword ptr [ebp-20h],eax</div><div class="line">010100d6 8b4de0          mov     ecx,dword ptr [ebp-20h]</div><div class="line">010100d9 ff154c31af00    call    dword ptr ds:[0AF314Ch] (ChlidClass..ctor(), mdToken: 06000008)</div><div class="line">010100df 8b45e0          mov     eax,dword ptr [ebp-20h]</div><div class="line">010100e2 8945f4          mov     dword ptr [ebp-0Ch],eax</div><div class="line">010100e5 b98831af00      mov     ecx,0AF3188h (MT: BrotherClass)</div><div class="line">010100ea e82d1fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">010100ef 8945dc          mov     dword ptr [ebp-24h],eax</div><div class="line">010100f2 8b4ddc          mov     ecx,dword ptr [ebp-24h]</div><div class="line">010100f5 ff15cc31af00    call    dword ptr ds:[0AF31CCh] (BrotherClass..ctor(), mdToken: 0600000c)</div><div class="line">010100fb 8b45dc          mov     eax,dword ptr [ebp-24h]</div><div class="line">010100fe 8945f0          mov     dword ptr [ebp-10h],eax</div><div class="line">01010101 b90832af00      mov     ecx,0AF3208h (MT: DerivedOfBrotherClass)</div><div class="line">01010106 e8111fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">0101010b 8945d8          mov     dword ptr [ebp-28h],eax</div><div class="line">0101010e 8b4dd8          mov     ecx,dword ptr [ebp-28h]</div><div class="line">01010111 ff154c32af00    call    dword ptr ds:[0AF324Ch] (DerivedOfBrotherClass..ctor(), mdToken: 06000010)</div><div class="line">01010117 8b45d8          mov     eax,dword ptr [ebp-28h]</div><div class="line">0101011a 8945ec          mov     dword ptr [ebp-14h],eax</div><div class="line">0101011d b90832af00      mov     ecx,0AF3208h (MT: DerivedOfBrotherClass)</div><div class="line">01010122 e8f51eadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">01010127 8945d4          mov     dword ptr [ebp-2Ch],eax</div><div class="line">0101012a 8b4dd4          mov     ecx,dword ptr [ebp-2Ch]</div><div class="line">0101012d ff154c32af00    call    dword ptr ds:[0AF324Ch] (DerivedOfBrotherClass..ctor(), mdToken: 06000010)</div><div class="line">01010133 8b45d4          mov     eax,dword ptr [ebp-2Ch]</div><div class="line">01010136 8945e8          mov     dword ptr [ebp-18h],eax</div><div class="line">01010139 8b4df8          mov     ecx,dword ptr [ebp-8]</div><div class="line">0101013c 8b01            mov     eax,dword ptr [ecx]</div><div class="line">0101013e ff5038          call    dword ptr [eax+38h]</div><div class="line">01010141 90              nop</div><div class="line">01010142 8b4df4          mov     ecx,dword ptr [ebp-0Ch]</div><div class="line">01010145 8b01            mov     eax,dword ptr [ecx]</div><div class="line">01010147 ff5038          call    dword ptr [eax+38h]</div><div class="line">0101014a 90              nop</div><div class="line">0101014b 8b4df0          mov     ecx,dword ptr [ebp-10h]</div><div class="line">0101014e 8b01            mov     eax,dword ptr [ecx]</div><div class="line">01010150 ff5038          call    dword ptr [eax+38h]</div><div class="line">01010153 90              nop</div><div class="line">01010154 8b4dec          mov     ecx,dword ptr [ebp-14h]</div><div class="line">01010157 8b01            mov     eax,dword ptr [ecx]</div><div class="line">01010159 ff5038          call    dword ptr [eax+38h]</div><div class="line">0101015c 90              nop</div><div class="line">0101015d 8b4dec          mov     ecx,dword ptr [ebp-14h]</div><div class="line">01010160 8b01            mov     eax,dword ptr [ecx]</div><div class="line">01010162 ff503c          call    dword ptr [eax+3Ch]</div><div class="line">01010165 90              nop</div><div class="line">01010166 8b4de8          mov     ecx,dword ptr [ebp-18h]</div><div class="line">01010169 8b01            mov     eax,dword ptr [ecx]</div><div class="line">0101016b ff5040          call    dword ptr [eax+40h]</div><div class="line">0101016e 90              nop</div><div class="line">0101016f e8fc477878      call    mscorlib_ni+0x6d4970 (79794970) (System.Console.ReadLine(), mdToken: 060007ba)</div><div class="line">01010174 90              nop</div><div class="line">01010175 90              nop</div><div class="line">01010176 8be5            mov     esp,ebp</div><div class="line">01010178 5d              pop     ebp</div><div class="line">01010179 c3              ret</div></pre></td></tr></table></figure>
</li>
<li><p>这里最重要的几行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">01010139 8b4df8          mov     ecx,dword ptr [ebp-8]   // 这里是BaseClass实例对象的地址 放到 ecx寄存器,Jit采用类似fastcall的调用协定,前2个不大于4字节的参数用 ecx edx来传递,而实例方法的调用第一个参数是隐含的this指针(托管对象在托管堆上的地址),如果是静态方法就不需要传this pointer了</div><div class="line">0101013c 8b01            mov     eax,dword ptr [ecx]    // 托管堆上的对象(值类型装箱后也是一样)第一个4字节(64位8字节)是对象的方法表地址(MethodTable),这里是把方法表(MethodTable)地址赋给eax寄存器</div><div class="line">0101013e ff5038          call    dword ptr [eax+38h]    // 这里就是实际的方法调用 上面说了 第一个虚方法在方法表的偏移28h位置,前4个是Object里的4个虚方法,所以 VirtualFun1 的入口在方法表地址(MT) + 28h + 4×4字节 也就是偏移38h的位置</div><div class="line">01010141 90              nop</div><div class="line">01010142 8b4df4          mov     ecx,dword ptr [ebp-0Ch]    // 这里是 ChlidClass的对象地址赋给ecx</div><div class="line">01010145 8b01            mov     eax,dword ptr [ecx]    // 同样ChlidClass的方法表地址赋给eax</div><div class="line">01010147 ff5038          call    dword ptr [eax+38h]    // 调用ChlidClass方法表偏移38h的方法,也是VirtualFun1 方法</div><div class="line">0101014a 90              nop</div><div class="line">0101014b 8b4df0          mov     ecx,dword ptr [ebp-10h]    // BrotherClass的对象地址赋给ecx</div><div class="line">0101014e 8b01            mov     eax,dword ptr [ecx]    // BrotherClass方法表地址赋给eax</div><div class="line">01010150 ff5038          call    dword ptr [eax+38h]    // 调用BrotherClass方法表偏移38h的方法,也是VirtualFun1 方法</div><div class="line">01010153 90              nop</div><div class="line">01010154 8b4dec          mov     ecx,dword ptr [ebp-14h]    // DerivedOfBrotherClass的对象地址赋给ecx</div><div class="line">01010157 8b01            mov     eax,dword ptr [ecx]    // DerivedOfBrotherClass方法表地址赋给eax</div><div class="line">01010159 ff5038          call    dword ptr [eax+38h]     // 调用DerivedOfBrotherClass方法表偏移38h的方法,也是VirtualFun1 方法</div><div class="line">0101015c 90              nop</div><div class="line">0101015d 8b4dec          mov     ecx,dword ptr [ebp-14h]    // 还是DerivedOfBrotherClass对象地址</div><div class="line">01010160 8b01            mov     eax,dword ptr [ecx]    // DerivedOfBrotherClass的方法表赋给eax</div><div class="line">01010162 ff503c          call    dword ptr [eax+3Ch]    // 这次偏移不一样了,第6个方法 VirtualFun2 (28h+5×4字节)</div><div class="line">01010165 90              nop</div><div class="line">01010166 8b4de8          mov     ecx,dword ptr [ebp-18h]    // 还是DerivedOfBrotherClass对象地址</div><div class="line">01010169 8b01            mov     eax,dword ptr [ecx]    // DerivedOfBrotherClass的方法表赋给eax</div><div class="line">0101016b ff5040          call    dword ptr [eax+40h]    // 这次偏移又不一样了,第7个方法 VirtualFun3 (28h+6×4字节)</div></pre></td></tr></table></figure>
</li>
<li><p><strong>可以看到 继承多态在CLR运行时的实现是通过方法表的偏移 间接调用的,而方法表内继承虚方法的构建顺序是先父类再子类,由于.NET是单一继承,这样就确保了在同一家族的同一虚方法的偏移量是一样的.</strong></p>
</li>
<li><p>接下来用Framework 4.0 编译下源码,4.0 和2.0相比 在实现上多了一层间接寻址,但思路是一样的</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">%windir%\Microsoft.NET\Framework\v4.0.30319\csc.exe /debug /target:exe /out:e:\temp\Polymorphism01_4.0.exe e:\temp\Polymorphism01.cs</div><div class="line">pause</div></pre></td></tr></table></figure>
<ul>
<li><p>运行 Polymorphism01_4.0.exe </p>
</li>
<li><p>启动windbg 附加进程 加载SOS (这里要加载对于4.0的sos.dll) </p>
</li>
<li>直接查找Main方法:<br><code>!Name2EE Polymorphism01_4.0.exe Program.Main</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !Name2EE Polymorphism01_4.0.exe Program.Main</div><div class="line">Module:      00b32ea4</div><div class="line">Assembly:    Polymorphism01_4.0.exe</div><div class="line">Token:       06000001</div><div class="line">MethodDesc:  00b33838</div><div class="line">Name:        Program.Main(System.String[])</div><div class="line">JITTED Code Address: 033a0070</div></pre></td></tr></table></figure>
<ul>
<li><p>看Main方法的区别:<code>!u 033a0070</code><br>这里只截取最重要的一段,调用构造器和其他的部分都先忽略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">e:\temp\Polymorphism01.cs @ 16:</div><div class="line">033a0139 8b4df8          mov     ecx,dword ptr [ebp-8]  // 这个还是一样BaseClass对象的地址赋给ecx</div><div class="line">033a013c 8b01            mov     eax,dword ptr [ecx]    // 还是对象的第一个4字节是方法表地址 赋给eax</div><div class="line">033a013e 8b4028          mov     eax,dword ptr [eax+28h]    // 这里是和2.0的区别 所有继承的虚方法的起始地址保存在方法表偏移28h的位置,也就是偏移量不是从方法表地址开始算了</div><div class="line">033a0141 ff5010          call    dword ptr [eax+10h]    // 这里的方式一样的 eax是虚方法的起始位置了,前4个是Object的4个虚方法,偏移10h是第5个方法 VirtualFun1</div><div class="line">033a0144 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 17:</div><div class="line">033a0145 8b4df4          mov     ecx,dword ptr [ebp-0Ch]    // ChlidClass对象地址赋给ecx</div><div class="line">033a0148 8b01            mov     eax,dword ptr [ecx]    // ChlidClass方法表地址赋给eax</div><div class="line">033a014a 8b4028          mov     eax,dword ptr [eax+28h]    // 虚表入口地址赋给eax</div><div class="line">033a014d ff5010          call    dword ptr [eax+10h]    //还是偏移到第5个方法 VirtualFun1</div><div class="line">033a0150 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 18:</div><div class="line">033a0151 8b4df0          mov     ecx,dword ptr [ebp-10h]    // BrotherClass对象地址赋给ecx</div><div class="line">033a0154 8b01            mov     eax,dword ptr [ecx]     // BrotherClass方法表地址赋给eax</div><div class="line">033a0156 8b4028          mov     eax,dword ptr [eax+28h]    // 虚表入口地址赋给eax</div><div class="line">033a0159 ff5010          call    dword ptr [eax+10h]    //还是偏移到第5个方法 VirtualFun1</div><div class="line">033a015c 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 19:</div><div class="line">033a015d 8b4dec          mov     ecx,dword ptr [ebp-14h]    // DerivedOfBrotherClass对象地址赋给ecx</div><div class="line">033a0160 8b01            mov     eax,dword ptr [ecx]    // DerivedOfBrotherClass方法表地址赋给eax</div><div class="line">033a0162 8b4028          mov     eax,dword ptr [eax+28h]    // 虚表入口地址赋给eax</div><div class="line">033a0165 ff5010          call    dword ptr [eax+10h]    //还是偏移到第5个方法 VirtualFun1</div><div class="line">033a0168 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 20:</div><div class="line">033a0169 8b4dec          mov     ecx,dword ptr [ebp-14h]    // 上面同一个对象</div><div class="line">033a016c 8b01            mov     eax,dword ptr [ecx]</div><div class="line">033a016e 8b4028          mov     eax,dword ptr [eax+28h]</div><div class="line">033a0171 ff5014          call    dword ptr [eax+14h]    // 这里比上面的调用多偏移了4个字节 也就是第6个方法 VirtualFun2</div><div class="line">033a0174 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 21:</div><div class="line">033a0175 8b4de8          mov     ecx,dword ptr [ebp-18h]    // 和上面不是同一个对象地址,但是是实例化同样类型的对象</div><div class="line">033a0178 8b01            mov     eax,dword ptr [ecx]</div><div class="line">033a017a 8b4028          mov     eax,dword ptr [eax+28h]</div><div class="line">033a017d ff5018          call    dword ptr [eax+18h]     // 这里比上面的调用再多偏移了4个字节 也就是第7个方法 VirtualFun3</div><div class="line">033a0180 90              nop</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p><strong>.NET 4.0 比2.0 多了一次间接寻址,就是先偏移到虚表的入口,再从这个入口开始偏移到相应的方法,这样的好处(个人觉得)虚表的存储位置可以更灵活 如果方法表(MT)包含多个可变长结构也没问题 只要入口地址保存在偏移28h的位置即可</strong></p>
</li>
</ul>
<blockquote>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><p><a href="https://www.microsoft.com/china/MSDN/library/netFramework/netframework/JITCompiler.mspx?mfr=true" target="_blank" rel="external">https://www.microsoft.com/china/MSDN/library/netFramework/netframework/JITCompiler.mspx?mfr=true</a><br><a href="http://www.codeproject.com/Articles/20481/NET-Type-Internals-From-a-Microsoft-CLR-Perspecti" target="_blank" rel="external">http://www.codeproject.com/Articles/20481/NET-Type-Internals-From-a-Microsoft-CLR-Perspecti</a><br><a href="http://blogs.microsoft.co.il/sasha/2012/03/15/virtual-method-dispatch-and-object-layout-changes-in-clr-40/" target="_blank" rel="external">http://blogs.microsoft.co.il/sasha/2012/03/15/virtual-method-dispatch-and-object-layout-changes-in-clr-40/</a><br><a href="http://www.cnblogs.com/BlueTzar/articles/884694.html" target="_blank" rel="external">http://www.cnblogs.com/BlueTzar/articles/884694.html</a></p>
</blockquote>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/CLR/inheritance-polymorphism/" class="archive-article-date">
  	<time datetime="2016-10-19T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-10-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET/">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CLR/">CLR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JIT/">JIT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RunTime/">RunTime</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/CLR/">CLR</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
  
    <a href="/CLR/method-descriptor/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">CLR运行时细节 - Method Descriptor</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>











      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 chengl
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?f685bce203ffb2e96d5a6473d1252d95";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/NET/" style="font-size: 10px;">.NET</a> <a href="/tags/CLR/" style="font-size: 10px;">CLR</a> <a href="/tags/JIT/" style="font-size: 10px;">JIT</a> <a href="/tags/RunTime/" style="font-size: 10px;">RunTime</a>
    			</div>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">espider@126.com</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>