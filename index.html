<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>espider.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="blog for CLR details">
<meta property="og:type" content="website">
<meta property="og:title" content="espider.github.io">
<meta property="og:url" content="http://espider.github.io/index.html">
<meta property="og:site_name" content="espider.github.io">
<meta property="og:description" content="blog for CLR details">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="espider.github.io">
<meta name="twitter:description" content="blog for CLR details">
  
    <link rel="alternative" href="/atom.xml" title="espider.github.io" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/logo.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">chengl</a></h1>
		</hgroup>

		
		<p class="header-subtitle">blog for CLR details</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">@我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
		        
					<a class="rss" target="_blank" href="#" title="rss">rss</a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">chengl</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/img/logo.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">chengl</h1>
			</hgroup>
			
			<p class="header-subtitle">blog for CLR details</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-lldb-dotnet-core-python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/NET-Core/lldb-dotnet-core-python/">lldb 调试 linux下 .net Core 总结及开源扩展 yinuo</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- # lldb 调试 linux下 .net Core 总结及开源扩展 yinuo -->
<p>相信很多朋友在跟随微软.net core 从windows平台迁移至linux平台的过程中遇到很多别扭的地方，<br>这里我只聊聊 运行时 调试的那些事儿。</p>
<ul>
<li>首先从工具上来讲Windows上的windbg肯定是运行时的首选调试工具(因为有对应版本的SOS.dll)，在linux平台运行时调试需要切换到<strong>lldb (Only lldb is supported by the SOS plugin. gdb can be used to debug the coreclr code but with no SOS support.)</strong><br>调试器的原理和功能基本一样，但细节到某个功能的命令自然会有区别，尤其是熟练了其中1个的命令之后(比如之前在看汇编的时候是Intel格式，现在要适用AT&amp;T格式)…</li>
</ul>
<p>这里先总结一些个人常用的命令在 windbg下和lldb下的对比：</p>
<ul>
<li><strong>非托管命令:</strong></li>
</ul>
<table>
<thead>
<tr>
<th>非托管命令</th>
<th>lldb</th>
<th>windbg</th>
</tr>
</thead>
<tbody>
<tr>
<td>列出当前模块</td>
<td>image list</td>
<td>lmf</td>
</tr>
<tr>
<td>当前线程</td>
<td>thread list</td>
<td>~</td>
</tr>
<tr>
<td>当前线程栈回溯</td>
<td>thread backtrace</td>
<td>kp</td>
</tr>
<tr>
<td>所有线程栈回溯</td>
<td>thread backtrace all</td>
<td>~* kp</td>
</tr>
<tr>
<td>切换线程</td>
<td>thread select 2</td>
<td>~2s kp</td>
</tr>
<tr>
<td>查看寄存器</td>
<td>re r</td>
<td>r</td>
</tr>
<tr>
<td>查看内存(8字节)</td>
<td>memory read –size 8 –format x address</td>
<td>dq address</td>
</tr>
</tbody>
</table>
<p>LLDB同GDB的命令对比：<a href="https://lldb.llvm.org/lldb-gdb.html" target="_blank" rel="external">https://lldb.llvm.org/lldb-gdb.html</a></p>
<ul>
<li><strong>托管命令:</strong>  </li>
</ul>
<p>这里先介绍下自己写的开源lldb调试.net Core扩展模块 <a href="https://github.com/espider/yinuo" target="_blank" rel="external"><strong>Yinuo</strong></a><br>在使用lldb调试linux .net Core程序的过程中，有很多不适应的地方，比如遍历并查看所有线程的托管栈回溯 在windbg下可以<code>~*e !clrstack</code> 在lldb里虽然有<code>bt all</code>和<code>clrstack</code> 但是却只能手动切换单个线程再回溯，没有办法结合到一起，还有一个原因是lldb内命令输出的内容颜色统一，不太好区分重点关注的点，比如线程回溯比较关注方法名，托管对象转储比较关注内部对象地址等等，lldb的好处是支持python或者c++接口，可以通过接口方式写lldb的扩展来辅助我们调试过程，提高调试效率。<br>下面介绍下调试扩展 Yinuo 的加载过程：</p>
<ul>
<li><p>以下的软件环境 CentOS7，lldb-3.6.0，python-2.7.5</p>
</li>
<li><p>首先git下载模块 <strong><code>git clone https://github.com/espider/yinuo</code></strong><br>目录没有要求，但要记得，因为加载模块的时候要知道在哪。</p>
</li>
<li><p>启动lldb 并附加被调试的进程 <strong><code>(lldb) attach -p PID</code></strong></p>
</li>
<li><p>加载Yinuo调试模块 <strong><code>(lldb) command script import ~/yinuo/ynlldb.py</code></strong> 之前git下来的目录里的python文件</p>
</li>
</ul>
<p><img src="/img/core02/1.png" alt="" title="load yinuo python module">  </p>
<ul>
<li>成功加载ynlldb.py后可以 <strong><code>help</code></strong> 看下当前注册进来的命令，都以 yn_ 为前缀，加载模块的时候会判断当前的.net Core版本号，并自动加载对应版本的调试插件libsosplugin.so</li>
</ul>
<p><img src="/img/core02/2.png" alt="" title="yinuo module register commands"> </p>
<h3 id="接下来介绍下当前注册进lldb的辅助调试命令"><a href="#接下来介绍下当前注册进lldb的辅助调试命令" class="headerlink" title="接下来介绍下当前注册进lldb的辅助调试命令"></a>接下来介绍下当前注册进lldb的辅助调试命令</h3><ul>
<li><strong><code>yn_heap_dump</code></strong><br>查看当前托管堆信息命令，以色块和色块的比例直观的感受 Gen 0,1,2 LOH 在同一个堆内的比例 以及其实际大小(<strong>这里的比例按托管堆的地址空间计算，并没有排除Free的和Gen0没有使用的地址空间，由于比例可能相去甚远所以有可能看不到某个堆的色块</strong>)</li>
</ul>
<p><img src="/img/core02/3.png" alt="" title="yn_heap_dump command output"> </p>
<ul>
<li><strong><code>yn_object_dump</code></strong><br>转储托管对象，可以根据类型的方法表、类型名、对象地址 进行批量或者单个转储，同时计算对象(按方法表或类型的话针对每1个单独对象)所属托管堆的位置Gen 0,1,2,LOH，并统计4类堆内的数量。<br>支持选项和参数<ul>
<li><strong>–methodtable/-m</strong> 转储此方法表的所有对象，后跟方法表地址；</li>
<li><strong>–type/-t</strong> 转储此类型名的所有对象，后跟类型名(同方法表选项互斥 2选1)；</li>
<li><strong>–offset/-o</strong> 转储对象的同时是否深入转储其内部偏移对象，后跟该对象的偏移量(目前只支持1级内部偏移)</li>
<li><strong>–address/-a</strong> 转储单个对象，后跟对象地址</li>
<li><strong>–dumpobj/-d</strong> 是否转储对象，默认为True，如果不转储则只返回对象地址；</li>
<li><strong>–gen/-g</strong> 是否显示对象所在的堆Gen0,1,2,LOH，默认True；</li>
</ul>
</li>
</ul>
<p>例如想要查看 类型Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Frame`1[[Microsoft.AspNetCore.Hosting.Internal.HostingApplication+Context, Microsoft.AspNetCore.Hosting]] 方法表地址 <code>00007ff8711df620</code> 可以这样写转储命令：  </p>
<p><img src="/img/core02/4-1.png" alt="" title="yn_object_dump command output with methodtable"> </p>
<p><strong>这里会对输出内容做下颜色处理，比如我们比较关心其内部成员的Value这列，如果是地址的话会显示成黄色，方便调试时候的快速定位。</strong></p>
<p>如果想要转储某个对象可以这样写，根据对象地址：  </p>
<p><img src="/img/core02/4-4.png" alt="" title="yn_object_dump command output with object address"> </p>
<p>发现对象内的某个成员比较感兴趣，例如 刚刚的对象内偏移 <code>0xe0</code> 位置是 <code>RawTarget</code> </p>
<p><img src="/img/core02/4-5.png" alt="" title="yn_object_dump RawTarget"></p>
<p>想对其进行偏移转储 可以这样写：</p>
<p><img src="/img/core02/4-3.png" alt="" title="yn_object_dump with offset"></p>
<p><img src="/img/core02/4-2.png" alt="" title="yn_object_dump with offset output"></p>
<ul>
<li><strong><code>yn_thread_clrstack</code></strong><br>显示某个线程或者所有线程的托管栈回溯，不指定选项 <strong>–thread/-t</strong> 的话默认显示当前线程的托管栈回溯， <strong>-t</strong> 跟线程index可以回溯指定线程，或者 跟 <strong>all</strong>，来批量显示所有线程的托管栈回溯，参数 <strong>-a</strong> 可选(此为SOS命令clrstack可选参数)  </li>
</ul>
<p><img src="/img/core02/5.png" alt="" title="yn_thread_clrstack all threads"></p>
<p><img src="/img/core02/5-1.png" alt="" title="yn_thread_clrstack all threads -a"></p>
<p>这里也对输出的内容做了颜色处理，比如IP指令指针列和CallSite是我们比较关注的，这里分别用黄色和绿色标注。</p>
<ul>
<li><strong><code>yn_thread_pe</code></strong><br>显示某个线程或者所有线程托管异常，选项同 yn_thread_clrstack 一样  </li>
</ul>
<p><img src="/img/core02/6.png" alt="" title="yn_thread_pe all threads"></p>
<ul>
<li><strong><code>yn_transfer</code></strong><br>此命令只用于转移执行其他lldb命令，因为yinuo项目调试的时候会在当前目录生成一个log文件(ynlldb.log)会把所有执行的yinuo命令及输出写入日志便于以后的查询，使用例如：<code>yn_transfer dumpheap -stat</code> 会执行 <code>dumpheap -stat</code> 并把结果输出到终端和日志文件里。</li>
</ul>
<ul>
<li><strong>Yinuo</strong> 项目 License 采用 BSD，大家有兴趣可以自己调整或者联系我共同维护，实现自己的调试命令比较简单，git项目内的 commandlist 目录，所有自动注册的调试命令都在这里以，自命名.py文件即可，内容例子及说明如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> lldb</div><div class="line"><span class="keyword">import</span> commandlist.ynbase <span class="keyword">as</span> yn</div><div class="line"><span class="keyword">from</span> util.colorstyle <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> util.exportcontent <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="string">"""这里把自定义类型注册进来等待加载的时候自动注册"""</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_lldb_commands</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> [</div><div class="line">        YNTransfer()</div><div class="line">    ]</div><div class="line"></div><div class="line"><span class="string">"""自定义类型继承自yn.YNCommand即可"""</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">YNTransfer</span><span class="params">(yn.YNCommand)</span>:</span></div><div class="line">    <span class="string">""" transfer lldb command and exe it for log """</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="string">"""这个是注册到lldb里的命令名字"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># register function name in lldb</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'yn_transfer'</span></div><div class="line"></div><div class="line">    <span class="string">"""如果有选项的话在这里定义，基于python argparse模块实现的 """</span> </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">options</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> [</div><div class="line">        ]</div><div class="line"></div><div class="line">    <span class="string">"""描述信息"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">description</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'Transfer lldb command for log,e.g. arguments: dumpheap -stat'</span></div><div class="line"></div><div class="line">    <span class="string">"""这里是实际命令的具体实现了"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, options, arguments)</span>:</span></div><div class="line">        target = lldb.debugger.GetSelectedTarget()</div><div class="line">        <span class="keyword">if</span> target:</div><div class="line">            <span class="keyword">if</span> arguments:</div><div class="line">                YNTransfer.handle_command(arguments)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                export_content(<span class="string">'    no arguments in yn_transfer.'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            export_content(<span class="string">'    no target in current debugger.'</span>)</div><div class="line"></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_command</span><span class="params">(args)</span>:</span></div><div class="line">        (ci, result) = yn.run_log_command(</div><div class="line">            <span class="string">" "</span> + (<span class="string">" "</span>.join(args) <span class="keyword">if</span> len(args) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="string">''</span>))</div><div class="line">        success = result.Succeeded()</div><div class="line">        <span class="keyword">if</span> success:</div><div class="line">            output = result.GetOutput()</div><div class="line">            contents = output.strip()</div><div class="line">            lines = contents.splitlines(<span class="keyword">False</span>)</div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(lines)):</div><div class="line">                export_content(<span class="string">'    %s'</span> % lines[i])</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            export_content(</div><div class="line">                <span class="string">'    error="%s"'</span> %</div><div class="line">                use_style_level(</div><div class="line">                    important_level[<span class="string">'high2'</span>],</div><div class="line">                    result.GetError()))</div><div class="line">        export_content(</div><div class="line">            <span class="string">'    %s   '</span> %</div><div class="line">            use_style_level(</div><div class="line">                important_level[<span class="string">'low2'</span>],</div><div class="line">                <span class="string">'-------------'</span>))</div></pre></td></tr></table></figure>
<blockquote>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><p><a href="https://github.com/dotnet/coreclr/blob/master/Documentation/building/debugging-instructions.md" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/Documentation/building/debugging-instructions.md</a><br><a href="https://lldb.llvm.org/python-reference.html" target="_blank" rel="external">https://lldb.llvm.org/python-reference.html</a><br><a href="https://github.com/llvm-mirror/lldb" target="_blank" rel="external">https://github.com/llvm-mirror/lldb</a><br><a href="https://github.com/facebook/chisel" target="_blank" rel="external">https://github.com/facebook/chisel</a>  </p>
</blockquote>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/NET-Core/lldb-dotnet-core-python/" class="archive-article-date">
  	<time datetime="2017-07-12T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-13</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET-Core/">.NET Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LLDB/">LLDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/NET-Core/">.NET Core</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-dotnet-core-lldb" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/NET-Core/dotnet-core-lldb/">快速搭建本地 .NET Core 运行时调试环境</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- # 快速搭建本地 .NET Core 运行时调试环境 -->
<p>需要的软件环境：</p>
<ul>
<li>Oracle VM VirtualBox</li>
<li>CentOS 7</li>
<li>llvm lldb 3.6.0 (3.5.0我试过 dumpobj时候一直报无效参数 Invalid parameter T_T)</li>
</ul>
<p>先在VirtualBox创建新虚机：<br>一路 Next ，文件位置可以自定义下(默认是在Users/当前用户/.. 目录下)<br>创建完选在<br>设置 – 存储 里 选下 CentOS7的镜像文件<br>设置 – 网络里选 桥接网卡<br>然后启动虚机 开始安装CentOS7</p>
<p><img src="/img/core01/1-1.png" alt="" title="VirtualBox Step1"></p>
<p>安装过程基本都是默认选项，键盘、时区选下、软件选择 选 最小安装(Minimal Install)<br>开始安装，设置下root账号的密码</p>
<p><img src="/img/core01/1-2.png" alt="" title="VirtualBox Step2"></p>
<ul>
<li>下面所有命令都是在root权限下完成的</li>
</ul>
<p>安装后重启<br>root登录后先改网卡配置：<br>/etc/sysconfig/network-scripts/ 目录下会有个 ifcfg-e开头的文件，修改其内容：onboot=no改成onboot=yes<br>然后用 ifup 命令激活网口</p>
<p><img src="/img/core01/1-3.png" alt="" title="CentOS7 Step1"></p>
<p><img src="/img/core01/1-4.png" alt="" title="CentOS7 Step2"></p>
<p>安装net-tools<br><code>yum -y install net-tools</code><br>ifconfig 查看下IP地址</p>
<p><img src="/img/core01/1-5.png" alt="" title="CentOS7 ifconfig"></p>
<p>有了IP后就可以用自己习惯的ssh工具连接啦，比如：PuTTY</p>
<p>默认防火墙 <code>systemctl disable firewalld.service</code><br>重启 <code>reboot</code><br>验证状态 <code>firewall-cmd --state</code></p>
<p>安装 dotnet SDK<br><code>mkdir /home/tool &amp;&amp; cd /home/tool</code></p>
<p>下SDK<br><code>curl -sSL -o dotnet-1.1.tar.gz https://go.microsoft.com/fwlink/?LinkID=835019</code></p>
<p>创建目录 解压<br><code>mkdir -p /opt/dotnet &amp;&amp; tar zxf dotnet-1.1.tar.gz -C /opt/dotnet</code></p>
<p>创建链接<br><code>ln -s /opt/dotnet/dotnet /usr/local/bin</code></p>
<p>验证 <code>dotnet --info</code></p>
<p>如果验证出现如下错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Failed to load /opt/dotnet/shared/Microsoft.NETCore.App/1.1.0/libcoreclr.so, error: libunwind.so.8: cannot open shared object file: No such file or directory</div><div class="line">Failed to bind to CoreCLR at &apos;/opt/dotnet/shared/Microsoft.NETCore.App/1.1.0/libcoreclr.so&apos;</div></pre></td></tr></table></figure></p>
<p>则安装：<code>yum install libunwind</code></p>
<p>如果验证出现如下错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Failed to initialize CoreCLR, HRESULT: 0x80131500</div></pre></td></tr></table></figure></p>
<p>则安装：<code>yum install icu</code></p>
<p>成功则会有版本信息：</p>
<p><img src="/img/core01/1-6.png" alt="" title="dotnet --info"></p>
<p><strong>接下来安装llvm lldb</strong></p>
<p>相关依赖安装：</p>
<ul>
<li><code>yum -y install wget</code></li>
<li><code>yum install gcc</code></li>
<li><code>yum install gcc-c++</code></li>
<li><code>yum install swig python-devel libedit-devel</code></li>
</ul>
<p>下载llvm的源代码:</p>
<ul>
<li><code>wget http://releases.llvm.org/3.6.0/llvm-3.6.0.src.tar.xz</code></li>
<li><code>tar -xf llvm-3.6.0.src.tar.xz</code></li>
<li><code>mv llvm-3.6.0.src llvm</code></li>
</ul>
<p>下载clang的源代码:</p>
<ul>
<li><code>cd llvm/tools</code></li>
<li><code>wget http://releases.llvm.org/3.6.0/cfe-3.6.0.src.tar.xz</code> </li>
<li><code>tar -xf cfe-3.6.0.src.tar.xz</code></li>
<li><code>mv cfe-3.6.0.src clang</code></li>
</ul>
<p>下载lldb的源代码:</p>
<ul>
<li><code>wget http://releases.llvm.org/3.6.0/lldb-3.6.0.src.tar.xz</code></li>
<li><code>tar -xf lldb-3.6.0.src.tar.xz</code></li>
<li><code>mv lldb-3.6.0.src lldb</code></li>
</ul>
<p>下载compiler-rt的源代码:</p>
<ul>
<li><code>cd ../projects</code></li>
<li><code>wget http://releases.llvm.org/3.6.0/compiler-rt-3.6.0.src.tar.xz</code></li>
<li><code>tar -xf compiler-rt-3.6.0.src.tar.xz</code></li>
<li><code>mv compiler-rt-3.6.0.src compiler-rt</code></li>
</ul>
<p>下载libcxxabi的源代码:</p>
<ul>
<li><code>wget http://releases.llvm.org/3.6.0/libcxxabi-3.6.0.src.tar.xz</code></li>
<li><code>tar -xf libcxxabi-3.6.0.src.tar.xz</code></li>
<li><code>mv libcxxabi-3.6.0.src libcxxabi</code></li>
</ul>
<p>下载libcxx的源代码:</p>
<ul>
<li><code>wget http://releases.llvm.org/3.6.0/libcxx-3.6.0.src.tar.xz</code></li>
<li><code>tar -xf  libcxx-3.6.0.src.tar.xz</code></li>
<li><code>mv libcxx-3.6.0.src libcxx</code></li>
</ul>
<p>配置编译选项:</p>
<ul>
<li><code>cd ..</code></li>
<li><code>./configure --enable-optimized CC=gcc CXX=g++</code></li>
</ul>
<p>编译llvm:</p>
<ul>
<li><code>make</code></li>
</ul>
<p>漫长的等待… … …</p>
<p>如果编译过程这样的错误<code>c++: internal compiler error: Killed (program cc1plus</code> 则增加swap分区文件大小后再试：<br><code>dd if=/dev/zero of=/swapfile bs=1k count=2048000</code><br><code>mkswap /swapfile</code><br><code>swapon /swapfile</code></p>
<p>编译成功后  只安装lldb，进入llvm/tools/lldb中运行 <code>make install</code></p>
<p><strong>创建一个.net core web站点</strong><br><code>mkdir -p /home/www/core01 &amp;&amp; cd /home/www/core01</code></p>
<p><code>dotnet new -t web</code><br><code>dotnet restore</code><br><code>ASPNETCORE_URLS=&quot;http://*:5000&quot; dotnet run</code></p>
<p><img src="/img/core01/1-7.png" alt="" title="dotnet run"></p>
<p><strong>启动lldb 附加进程 加载SOS调试扩展</strong></p>
<p><img src="/img/core01/1-8.png" alt="" title="lldb libsosplugin.so"></p>
<p><strong>执行SOS命令：soshelp</strong></p>
<p><img src="/img/core01/1-9.png" alt="" title="lldb soshelp"></p>
<p><strong>看到熟悉的托管调试命令 甚是亲切 赶紧试试</strong></p>
<p><img src="/img/core01/1-10.png" alt="" title="lldb sos clrthreads"></p>
<p><img src="/img/core01/1-11.png" alt="" title="lldb sos eeheap -gc"></p>
<p><img src="/img/core01/1-12.png" alt="" title="lldb sos dumpheap -stat"></p>
<p><img src="/img/core01/1-13.png" alt="" title="lldb sos dumpobj"></p>
<p>此文只是简单快速的搭建 .NET Core 在CentOS7下运行时的调试环境，后续再总结 Windbg 和 LLDB 之间的命令习惯差异。</p>
<blockquote>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><p><a href="https://github.com/dotnet/coreclr/blob/master/Documentation/building/debugging-instructions.md" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/Documentation/building/debugging-instructions.md</a><br><a href="http://www.cnblogs.com/dudu/p/build-coreclr-on-centos.html" target="_blank" rel="external">http://www.cnblogs.com/dudu/p/build-coreclr-on-centos.html</a><br><a href="http://www.cnblogs.com/dudu/p/4294374.html" target="_blank" rel="external">http://www.cnblogs.com/dudu/p/4294374.html</a></p>
</blockquote>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/NET-Core/dotnet-core-lldb/" class="archive-article-date">
  	<time datetime="2017-02-28T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-03-01</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET-Core/">.NET Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/">Debug</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RunTime/">RunTime</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/NET-Core/">.NET Core</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-interface-polymorphism" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/CLR/interface-polymorphism/">CLR运行时细节 - 接口多态的实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- # CLR运行时细节 - 接口多态的实现 Interface Polymorphism Virtual Stub Dispatch -->
<h2 id=""><a href="#" class="headerlink" title=" "></a> </h2><p><strong>关于接口多态(Framework 2.0之后的版本),CLR运行时的实现比继承多态要复杂得多,而网上大部分的文章和资料描述的还是Framework 1.1的实现方式,2.0之后变化非常大,这也是写此文的目的,说明下2.0版本开始的实现细节。</strong><br><strong>先看个有趣的Demo:</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Diagnostics;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Program</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"Polymorphism02_01 demo"</span>);</div><div class="line">		<span class="keyword">int</span> loopCount = <span class="number">100000000</span>;</div><div class="line"></div><div class="line">		IFoo ifo = null;</div><div class="line">		Stopwatch sw = Stopwatch.StartNew();</div><div class="line"></div><div class="line">		<span class="meta">#region Case 1</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopCount; ++i)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				ifo = <span class="keyword">new</span> TestA();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				ifo = <span class="keyword">new</span> TestB();</div><div class="line">			&#125;</div><div class="line">			ifo.Foo();</div><div class="line">		&#125;</div><div class="line">		Console.WriteLine(<span class="string">"Case 1 take time: &#123;0&#125; ms"</span>, sw.ElapsedMilliseconds);</div><div class="line">		<span class="meta">#endregion</span></div><div class="line"></div><div class="line">		<span class="meta">#region Case 2</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopCount; ++i)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				ifo = <span class="keyword">new</span> TestA();</div><div class="line">				ifo.Foo();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				ifo = <span class="keyword">new</span> TestB();</div><div class="line">				ifo.Foo();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		Console.WriteLine(<span class="string">"Case 2 take time: &#123;0&#125; ms"</span>, sw.ElapsedMilliseconds);</div><div class="line">		<span class="meta">#endregion</span></div><div class="line"></div><div class="line">		sw.Reset();</div><div class="line">		Console.ReadLine();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> interface IFoo</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Foo</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> TestA : IFoo</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">try</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">int</span> i = <span class="number">1</span> + <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (Exception ex)</div><div class="line">		&#123; &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> TestB : IFoo</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">try</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">int</span> i = <span class="number">1</span> + <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (Exception ex)</div><div class="line">		&#123; &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>源码内有2种方案:</strong></p>
<ul>
<li>Case 1:根据条件实例化后 一次调用 实现的 <strong>Foo()</strong> 方法</li>
<li>Case 2:根据条件每次实例化后都立即调用实现的 <strong>Foo()</strong> 方法</li>
</ul>
<p>2种方案的功能上没有区别,只是写法上,第一种是我们日常多态的写法,第二种没有体现多态的优势.</p>
<p><strong>请用Framework 2.0(或者2.0以后的版本)分别编译 Case1功能和Case2功能,看2个方案的执行时间:</strong></p>
<p><img src="/img/02PMIP/01poly.png" alt="" title="interface 2.0 result"></p>
<p><strong>截图是我本地电脑的截图,不具有普遍性,但具有代表性:也就是 Case 2 的速度要比 Case 1 的速度快,这个性能的差异就与CLR运行时的实现有关系了.</strong></p>
<ul>
<li>我们先来简单看下 Framework 1.1 在接口多态的运行时实现方式,下面截取Main方法中关于接口调用部分:<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">012200b3 8bf7            mov     esi,edi</div><div class="line">012200b5 8bce            mov     ecx,esi</div><div class="line">012200b7 8b01            mov     eax,dword ptr [ecx]</div><div class="line">012200b9 8b400c          mov     eax,dword ptr [eax+0Ch]</div><div class="line">012200bc 8b80d0000000    mov     eax,dword ptr [eax+0D0h]</div><div class="line">012200c2 ff10            call    dword ptr [eax]</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>可以看到Framework1.1对于接口多态的运行时实现和4.0的继承多态实现类似,先把对象地址赋给ecx寄存器,在把对象第1个4字节(64位8字节)的方法表(MethodTable)赋给eax寄存器,再通过方法表地址偏移0Ch的位置 取出接口偏移表地址 IOT (Interface Offset Table) 赋给eax寄存器,再通过IOT偏移0D0h的位置 取出对应实现接口的方法入口地址 赋给eax寄存器,最后调用.</strong></p>
<p><strong>也就是每个类型的方法表内包含接口偏移表的入口地址(偏移0Ch的位置),再通过接口偏移表内相同的方法实现有着相同的偏移量来完成多态,但接口是可以多实现的,和继承不同,继承是单一继承(先父类再子类的排列顺序可以保证同一个虚方法的实现有着相同的偏移量),而接口的这种做法明显是以空间换时间的方案, Framework2.0 开始对于接口的调用实现有了非常大的调整.</strong></p>
<ul>
<li>通过下面的Demo看下2.0之后的实现</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Program</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"Polymorphism02_02 demo"</span>);</div><div class="line">		Console.ReadLine();</div><div class="line"></div><div class="line">		IFoo2 ifo2 = <span class="keyword">new</span> TestA();</div><div class="line">		ifo2.Foo2();</div><div class="line">		</div><div class="line">		IFoo1 ifo = null;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">102</span>; i++)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (i &lt;= <span class="number">1</span>)</div><div class="line">			&#123; ifo = <span class="keyword">new</span> TestA(); &#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123; ifo = <span class="keyword">new</span> TestB(); &#125;</div><div class="line">			</div><div class="line">			ifo.Foo11();</div><div class="line">		&#125;</div><div class="line">		Console.ReadLine();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> interface IFoo1</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Foo1</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Foo11</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> interface IFoo2</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Foo2</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> TestA : IFoo1,IFoo2</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"TestA IFoo1"</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo11</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"TestA Foo11"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"TestA Foo2"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> TestB : IFoo1,IFoo2</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"TestB IFoo1"</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo11</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"TestB Foo11"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"TestB Foo2"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>用2.0方式编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">%windir%\Microsoft.NET\Framework\v2.0.50727\csc.exe /debug /target:exe /out:e:\temp\Polymorphism02_02_2.0.exe e:\temp\Polymorphism02_02.cs</div><div class="line">pause</div></pre></td></tr></table></figure>
</li>
<li><p>运行程序并通过windbg附加到程序进程,查找Main方法的编译结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !u 01010070   </div><div class="line">Normal JIT generated code</div><div class="line">Program.Main(System.String[])</div><div class="line">Begin 01010070, size f2</div><div class="line">&gt;&gt;&gt; 01010070 55              push    ebp</div><div class="line">01010071 8bec            mov     ebp,esp</div><div class="line">01010073 83ec20          sub     esp,20h</div><div class="line">01010076 894dfc          mov     dword ptr [ebp-4],ecx</div><div class="line">01010079 833d142eaf0000  cmp     dword ptr ds:[0AF2E14h],0</div><div class="line">01010080 7405            je      01010087</div><div class="line">01010082 e832ff0d79      call    mscorwks!JIT_DbgIsJustMyCode (7a0effb9)</div><div class="line">01010087 33d2            xor     edx,edx</div><div class="line">01010089 8955ec          mov     dword ptr [ebp-14h],edx</div><div class="line">0101008c c745f400000000  mov     dword ptr [ebp-0Ch],0</div><div class="line">01010093 33d2            xor     edx,edx</div><div class="line">01010095 8955f8          mov     dword ptr [ebp-8],edx</div><div class="line">01010098 33d2            xor     edx,edx</div><div class="line">0101009a 8955f0          mov     dword ptr [ebp-10h],edx</div><div class="line">0101009d 90              nop</div><div class="line">0101009e 8b0d30204202    mov     ecx,dword ptr ds:[2422030h] (&quot;Polymorphism02_02 demo&quot;)</div><div class="line">*** WARNING: Unable to verify checksum for C:\WINDOWS\assembly\NativeImages_v2.0.50727_32\mscorlib\b14359470744c840c59fbe4e58034fd6\mscorlib.ni.dll</div><div class="line">010100a4 e8b3457878      call    mscorlib_ni+0x6d465c (7979465c) (System.Console.WriteLine(System.String), mdToken: 060007c8)</div><div class="line">010100a9 90              nop</div><div class="line">010100aa e8c1487878      call    mscorlib_ni+0x6d4970 (79794970) (System.Console.ReadLine(), mdToken: 060007ba)</div><div class="line">010100af 90              nop</div><div class="line">010100b0 b99431af00      mov     ecx,0AF3194h (MT: TestA)</div><div class="line">010100b5 e8621fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">010100ba 8945e8          mov     dword ptr [ebp-18h],eax</div><div class="line">010100bd 8b4de8          mov     ecx,dword ptr [ebp-18h]</div><div class="line">010100c0 ff15d831af00    call    dword ptr ds:[0AF31D8h] (TestA..ctor(), mdToken: 06000009)</div><div class="line">010100c6 8b45e8          mov     eax,dword ptr [ebp-18h]</div><div class="line">010100c9 8945f0          mov     dword ptr [ebp-10h],eax</div><div class="line">010100cc 8b4df0          mov     ecx,dword ptr [ebp-10h]</div><div class="line">010100cf ff151000b000    call    dword ptr ds:[0B00010h]</div><div class="line">010100d5 90              nop</div><div class="line">010100d6 33d2            xor     edx,edx</div><div class="line">010100d8 8955ec          mov     dword ptr [ebp-14h],edx</div><div class="line">010100db 33d2            xor     edx,edx</div><div class="line">010100dd 8955f8          mov     dword ptr [ebp-8],edx</div><div class="line">010100e0 90              nop</div><div class="line">010100e1 eb61            jmp     01010144</div><div class="line">010100e3 90              nop</div><div class="line">010100e4 837df801        cmp     dword ptr [ebp-8],1</div><div class="line">010100e8 0f9fc0          setg    al</div><div class="line">010100eb 0fb6c0          movzx   eax,al</div><div class="line">010100ee 8945f4          mov     dword ptr [ebp-0Ch],eax</div><div class="line">010100f1 837df400        cmp     dword ptr [ebp-0Ch],0</div><div class="line">010100f5 7521            jne     01010118</div><div class="line">010100f7 90              nop</div><div class="line">010100f8 b99431af00      mov     ecx,0AF3194h (MT: TestA)</div><div class="line">010100fd e81a1fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">01010102 8945e0          mov     dword ptr [ebp-20h],eax</div><div class="line">01010105 8b4de0          mov     ecx,dword ptr [ebp-20h]</div><div class="line">01010108 ff15d831af00    call    dword ptr ds:[0AF31D8h] (TestA..ctor(), mdToken: 06000009)</div><div class="line">0101010e 8b45e0          mov     eax,dword ptr [ebp-20h]</div><div class="line">01010111 8945ec          mov     dword ptr [ebp-14h],eax</div><div class="line">01010114 90              nop</div><div class="line">01010115 90              nop</div><div class="line">01010116 eb1e            jmp     01010136</div><div class="line">01010118 90              nop</div><div class="line">01010119 b92832af00      mov     ecx,0AF3228h (MT: TestB)</div><div class="line">0101011e e8f91eadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">01010123 8945e4          mov     dword ptr [ebp-1Ch],eax</div><div class="line">01010126 8b4de4          mov     ecx,dword ptr [ebp-1Ch]</div><div class="line">01010129 ff156c32af00    call    dword ptr ds:[0AF326Ch] (TestB..ctor(), mdToken: 0600000d)</div><div class="line">0101012f 8b45e4          mov     eax,dword ptr [ebp-1Ch]</div><div class="line">01010132 8945ec          mov     dword ptr [ebp-14h],eax</div><div class="line">01010135 90              nop</div><div class="line">01010136 8b4dec          mov     ecx,dword ptr [ebp-14h]</div><div class="line">01010139 ff159000b000    call    dword ptr ds:[0B00090h]</div><div class="line">0101013f 90              nop</div><div class="line">01010140 90              nop</div><div class="line">01010141 ff45f8          inc     dword ptr [ebp-8]</div><div class="line">01010144 837df866        cmp     dword ptr [ebp-8],66h</div><div class="line">01010148 0f9ec0          setle   al</div><div class="line">0101014b 0fb6c0          movzx   eax,al</div><div class="line">0101014e 8945f4          mov     dword ptr [ebp-0Ch],eax</div><div class="line">01010151 837df400        cmp     dword ptr [ebp-0Ch],0</div><div class="line">01010155 758c            jne     010100e3</div><div class="line">01010157 e814487878      call    mscorlib_ni+0x6d4970 (79794970) (System.Console.ReadLine(), mdToken: 060007ba)</div><div class="line">0101015c 90              nop</div><div class="line">0101015d 90              nop</div><div class="line">0101015e 8be5            mov     esp,ebp</div><div class="line">01010160 5d              pop     ebp</div><div class="line">01010161 c3              ret</div></pre></td></tr></table></figure>
</li>
<li><p>这里最重要的几行：<br><code>010100cf ff151000b000    call    dword ptr ds:[0B00010h]</code><br>对应源码：<code>ifo2.Foo2();</code></p>
</li>
</ul>
<p><code>01010139 ff159000b000    call    dword ptr ds:[0B00090h]</code><br>对应源码：<code>ifo.Foo11();</code></p>
<p><strong>也就是说运行时不管调用这个接口方法的实例是什么类型的都通过这个内存地址的内容去到相应的实现</strong><br>前来看看目前这2块内存的内容：</p>
<p><img src="/img/02PMIP/1-1.png" alt="" title="memory indcellHeap"></p>
<p>分别指向 <code>00b06012</code> 和 <code>00b06022</code> 这4个内容地址所属的位置：</p>
<p><img src="/img/02PMIP/1-2.png" alt="" title="Domain Virtual Call Stub Heap"></p>
<p>也就是说运行时为每个调用点(<strong>call site</strong>)分配一个 Indirect cell (在应用程序域的IndcellHeap堆内)默认情况下其内容指针指向 Lookup Cell(在应用程序域的LookupHeap堆内)，再来看看这2块lookupHeap的内容：</p>
<p><img src="/img/02PMIP/1-3.png" alt="" title="ResolveWorkerAsmStub"></p>
<p>这里2个 <strong>DispatchToken</strong> 30000h，50001h分别代表2个接口方法的调用，DispatchToken的构成比较有意思，分为2段各16位(目前是32位进程)，高16位是TypeID，应用程序域在运行时为每个接口类型动态分配的ID，也就是接口类型在运行时唯一的标识，TypeID的起始值是3步长是2，应用程序域内持有2个HashMap分别用于对于TypeID和方法表的对应(MethodTable)，以及方法表对应TypeID</p>
<p><img src="/img/02PMIP/1-4.png" alt="" title="Domain TypeID HashMap"></p>
<p><img src="/img/02PMIP/1-5.png" alt="" title="Domain TypeID HashMap2"></p>
<ul>
<li>这2个HashMap的Hash算法是一样的：每个桶存储4对 key/value 算法是Hash key 右移2位为种子(seed)，种子模桶的长度找到对应的桶，然后循环桶内的4个slot匹配key，如果桶已满，则种子增加incr 继续查找。</li>
<li>图里方法表00af312c是IFoo2的方法表，00af30c0是IFoo1的方法表，可以看出在运行时先编译到IFoo2的方法调用，所以先为IFoo2分配TypeID=3，再编译到IFoo1的方法调用 TypeID=5</li>
<li>在第一个HashMap(TypeID-&gt;MT)内，IFoo2的key:3右移2位为0，所以在0号桶内，value:MT 右移1位存如桶内对应的位置。IFoo1的key:5 右移2位为1，所以在1号桶内，value:MT 右移1位存入桶内对应的位置。</li>
<li>在第二个HashMap(MT-&gt;TypeID)内，IFoo2的key:00af312c右移2位为2BCC4B 再模11为7，所以IFoo2的MT和TypeID在7号桶，同样IFoo1的key：00af30c0右移2位为2BCC30 再模11为2，所以IFoo1的MT和TypeID在2号桶里。</li>
</ul>
<p><img src="/img/02PMIP/1-6.png" alt="" title="interface methodtable"></p>
<p><strong>DispatchToken的低16位是由方法在接口内的方法索引(slot index前面的文章介绍过如果查看方法描述及方法槽索引)，也就是在运行时DispatchToken可以唯一代表某个接口的某个方法调用，这里和实现类还没有关系。</strong></p>
<p>在循环内i=2的时候再中断观察接口调用(call site)的内存变化(这里前2次都用TestA来实例化是因为IndcellHeap的内容并不是立刻被改的，官方的说法：<strong>appropriate do it</strong>)</p>
<p><img src="/img/02PMIP/1-7.png" alt="" title="indcellHeap to DispatchHeap"></p>
<p>目前的调用点IndcellHeap的内容指向了DispatchHeap，内容也有了变化：</p>
<p><img src="/img/02PMIP/1-8.png" alt="" title="DispatchHeap"></p>
<p><img src="/img/02PMIP/1-9.png" alt="" title="DispatchHeap content"></p>
<p>可以看到DispatchHeap的内容就3行，第一行比较传进来的对象是不是TestA类型的，不是的话跳到 00b0a011，是TestA类型的话跳到 010101e8，这个010101e8就是TestA类型实现接口方法 Foo11 的入口，也就是运行时先假设我们传进来的对象都是TestA，这样经过短短的几条指令就能到达TestA的接口实现，那如果不是TestA呢？TestB也实现了，并且在运行时调用了。看下条件失败的调整地址情况：</p>
<p><img src="/img/02PMIP/1-10.png" alt="" title="DispatchHeap content2"></p>
<p>第1句是对某个内存地址减1的操作，看下这块内存目前内容是64h(十进制的100)，也就是在多态接口调用的时候不是TestA对象的话会进入另外一个流程，并在其内部做1个失败计数器，从100开始递减，递减的过程：</p>
<p><img src="/img/02PMIP/1-10-1.png" alt="" title="DispatchHeap content3"></p>
<p>最终减完会发生什么，等程序循环执行完再观察调用点的内存。</p>
<p><img src="/img/02PMIP/1-11.png" alt="" title="ResolveHeap content"></p>
<p>接口调用点(call site)IndcellHeap的内容指向了ResolveHeap，ResolveHeap的内容：</p>
<p><img src="/img/02PMIP/1-12.png" alt="" title="ResolveHeap content2"></p>
<p>现在调用点的IndcellHeap内容就不再变化了，不管再用那个对象在循环内再调用Foo11方法，都是通过ResolveHeap内存的方法进行中转的。</p>
<h5 id="总结下：-NET-2-0-开始对接口的多态实现比1-1的时候要复杂的多，也更灵活，它假设我们在接口调用的时候是单态的-或者说多态的次数不多的情况，用某个实现类的方法表-MT-加以判断，如果是则直接跳到这个实现类的接口实现入口，如果不是-则对失败进行计数，并在失败达到一定数量后-100次-认为确实是多态调用，并将call-site的入口指向ResolveHeap，此时不再单独判断某个类型的方法表-MT-，这也是为何在文章开头的Demo里为何2种写法的性能是有差别的原因了。"><a href="#总结下：-NET-2-0-开始对接口的多态实现比1-1的时候要复杂的多，也更灵活，它假设我们在接口调用的时候是单态的-或者说多态的次数不多的情况，用某个实现类的方法表-MT-加以判断，如果是则直接跳到这个实现类的接口实现入口，如果不是-则对失败进行计数，并在失败达到一定数量后-100次-认为确实是多态调用，并将call-site的入口指向ResolveHeap，此时不再单独判断某个类型的方法表-MT-，这也是为何在文章开头的Demo里为何2种写法的性能是有差别的原因了。" class="headerlink" title="总结下：.NET 2.0 开始对接口的多态实现比1.1的时候要复杂的多，也更灵活，它假设我们在接口调用的时候是单态的 或者说多态的次数不多的情况，用某个实现类的方法表(MT)加以判断，如果是则直接跳到这个实现类的接口实现入口，如果不是 则对失败进行计数，并在失败达到一定数量后(100次)认为确实是多态调用，并将call site的入口指向ResolveHeap，此时不再单独判断某个类型的方法表(MT)，这也是为何在文章开头的Demo里为何2种写法的性能是有差别的原因了。"></a>总结下：.NET 2.0 开始对接口的多态实现比1.1的时候要复杂的多，也更灵活，它假设我们在接口调用的时候是单态的 或者说多态的次数不多的情况，用某个实现类的方法表(MT)加以判断，如果是则直接跳到这个实现类的接口实现入口，如果不是 则对失败进行计数，并在失败达到一定数量后(100次)认为确实是多态调用，并将call site的入口指向ResolveHeap，此时不再单独判断某个类型的方法表(MT)，这也是为何在文章开头的Demo里为何2种写法的性能是有差别的原因了。</h5><blockquote>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><p><a href="https://github.com/dotnet/coreclr/blob/master/Documentation/botr/virtual-stub-dispatch.md" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/Documentation/botr/virtual-stub-dispatch.md</a><br><a href="http://blogs.microsoft.co.il/sasha/2012/03/15/virtual-method-dispatch-and-object-layout-changes-in-clr-40/" target="_blank" rel="external">http://blogs.microsoft.co.il/sasha/2012/03/15/virtual-method-dispatch-and-object-layout-changes-in-clr-40/</a><br><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/methodtable.h" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/src/vm/methodtable.h</a><br><a href="https://www.microsoft.com/china/MSDN/library/netFramework/netframework/JITCompiler.mspx?mfr=true" target="_blank" rel="external">https://www.microsoft.com/china/MSDN/library/netFramework/netframework/JITCompiler.mspx?mfr=true</a></p>
</blockquote>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/CLR/interface-polymorphism/" class="archive-article-date">
  	<time datetime="2017-02-27T01:05:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-02-27</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET/">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CLR/">CLR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JIT/">JIT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RunTime/">RunTime</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/CLR/">CLR</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-inheritance-polymorphism" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/CLR/inheritance-polymorphism/">CLR运行时细节 - 继承多态的实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- # CLR运行时细节 - 继承多态的实现 Inheritance Polymorphism Virtual Dispatch -->
<h2 id=""><a href="#" class="headerlink" title=" "></a> </h2><p>关于多态不多解释了,在运行时决定和调用具体的实现,是面向对象的基础 设计模式的基础.<br>准备把继承多态和接口多态分开,因为从CLR实现的角度继承多态相比于接口多态要简单得多,也更容易理解,本篇只讨论继承多态, .NET Framework 2.0 和 4.0 这两个版本在实现上稍微有点区别(这里先忽略方法Jit编译的过程,只关注实现的方式).</p>
<p><strong>废话不多,先看代码: C# Polymorphism01.cs</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Runtime.CompilerServices;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Program</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"Polymorphism01 demo"</span>);</div><div class="line"></div><div class="line">		BaseClass bc = <span class="keyword">new</span> BaseClass();</div><div class="line">		BaseClass bc1 = <span class="keyword">new</span> ChlidClass();</div><div class="line">		BaseClass bc2 = <span class="keyword">new</span> BrotherClass();</div><div class="line">		BaseClass bc3 = <span class="keyword">new</span> DerivedOfBrotherClass();</div><div class="line">		BrotherClass bc4 = <span class="keyword">new</span> DerivedOfBrotherClass();</div><div class="line">		</div><div class="line">		bc.VirtualFun1();</div><div class="line">		bc1.VirtualFun1();</div><div class="line">		bc2.VirtualFun1();</div><div class="line">		bc3.VirtualFun1();</div><div class="line">		bc3.VirtualFun2();</div><div class="line">		bc4.VirtualFun3();</div><div class="line">		</div><div class="line">		Console.ReadLine();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> BaseClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BaseClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BaseClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> ChlidClass : BaseClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"ChlidClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"ChlidClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> BrotherClass : BaseClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BrotherClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BrotherClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">VirtualFun3</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"BrotherClass VirtualFun3"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> DerivedOfBrotherClass : BrotherClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"DerivedOfBrotherClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"DerivedOfBrotherClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun3</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"DerivedOfBrotherClass VirtualFun3"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>编译代码 先用 .Net Framework 2.0 编译:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">%windir%\Microsoft.NET\Framework\v2.0.50727\csc.exe /debug /target:exe /out:e:\temp\Polymorphism01_2.0.exe e:\temp\Polymorphism01.cs</div><div class="line">pause</div></pre></td></tr></table></figure>
</li>
<li><p>运行 Polymorphism01_2.0.exe </p>
</li>
<li><p>启动windbg 附加进程 加载SOS </p>
</li>
<li><p>查找对应的模块：<br><code>!Name2EE *!Polymorphism01_2.0.exe</code></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !Name2EE *!Polymorphism01_2.0.exe</div><div class="line">Module: 790c1000 (mscorlib.dll)</div><div class="line">--------------------------------------</div><div class="line">Module: 00af2c5c (Polymorphism01_2.0.exe)</div></pre></td></tr></table></figure>
<ul>
<li><p>根据模块查找方法表:<br><code>!DumpModule -mt 00af2c5c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !DumpModule -mt 00af2c5c</div><div class="line">Name: E:\temp\Polymorphism01_2.0.exe</div><div class="line">Attributes: PEFile </div><div class="line">Assembly: 00167720</div><div class="line">LoaderHeap: 00000000</div><div class="line">TypeDefToMethodTableMap: 00af00c0</div><div class="line">TypeRefToMethodTableMap: 00af00dc</div><div class="line">MethodDefToDescMap: 00af0100</div><div class="line">FieldDefToDescMap: 00af0144</div><div class="line">MemberRefToDescMap: 00af0148</div><div class="line">FileReferencesMap: 00af016c</div><div class="line">AssemblyReferencesMap: 00af0170</div><div class="line">MetaData start address: 00402170 (1756 bytes)</div><div class="line"></div><div class="line">Types defined in this module</div><div class="line"></div><div class="line">      MT    TypeDef Name</div><div class="line">------------------------------------------------------------------------------</div><div class="line">00af302c 0x02000002 Program</div><div class="line">00af3098 0x02000003 BaseClass</div><div class="line">00af310c 0x02000004 ChlidClass</div><div class="line">00af3188 0x02000005 BrotherClass</div><div class="line">00af3208 0x02000006 DerivedOfBrotherClass</div><div class="line"></div><div class="line">Types referenced in this module</div><div class="line"></div><div class="line">      MT    TypeRef Name</div><div class="line">------------------------------------------------------------------------------</div><div class="line">793308f8 0x01000001 System.Object</div><div class="line">79334648 0x01000006 System.Console</div></pre></td></tr></table></figure>
</li>
<li><p>先分别看下 BaseClass BrotherClass DerivedOfBrotherClass 这3个继承关系类的方法表(MethodTable)</p>
</li>
</ul>
<p><img src="/img/02PM/BaseClass.png" alt="" title="BaseClass MethodTable"></p>
<p><img src="/img/02PM/BrotherClass.png" alt="" title="BrotherClass MethodTable"></p>
<p><img src="/img/02PM/DerivedOfBrotherClass.png" alt="" title="DerivedOfBrotherClass MethodTable"></p>
<ul>
<li><strong>可以看到第一个虚方法(ToString)的入口都是在方法表偏移28h的位置,其顺序是先父类,再子类,这样的安排让所有同一个家族(继承关系)的类型继承虚方法的顺序是一样的,并且偏移量是一样的,所有的类型(除了接口类型)的父类都是(或者间接是)System.Object,所以前4个虚方法肯定是Object里的4个虚方法(ToString Equals GetHashCode Finalize)</strong>  </li>
<li><p>通过Program 的方法表(MethodTable)找到Main方法的入口地址:<br><code>!DumpMT -md 00af302c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !DumpMT -md 00af302c</div><div class="line">EEClass: 00af12f4</div><div class="line">Module: 00af2c5c</div><div class="line">Name: Program</div><div class="line">mdToken: 02000002  (E:\temp\Polymorphism01_2.0.exe)</div><div class="line">BaseSize: 0xc</div><div class="line">ComponentSize: 0x0</div><div class="line">Number of IFaces in IFaceMap: 0</div><div class="line">Slots in VTable: 6</div><div class="line">--------------------------------------</div><div class="line">MethodDesc Table</div><div class="line">   Entry MethodDesc      JIT Name</div><div class="line">79286aa0   79104960   PreJIT System.Object.ToString()</div><div class="line">79286ac0   79104968   PreJIT System.Object.Equals(System.Object)</div><div class="line">79286b30   79104998   PreJIT System.Object.GetHashCode()</div><div class="line">792f76d0   791049bc   PreJIT System.Object.Finalize()</div><div class="line">00afc015   00af3024     NONE Program..ctor()</div><div class="line">01010070   00af3018      JIT Program.Main(System.String[])</div></pre></td></tr></table></figure>
</li>
<li><p>Main方法已经Jit编译,看看被编译成啥样子:<br><code>!u 01010070</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !u 01010070</div><div class="line">Normal JIT generated code</div><div class="line">Program.Main(System.String[])</div><div class="line">Begin 01010070, size 10a</div><div class="line">&gt;&gt;&gt; 01010070 55              push    ebp</div><div class="line">01010071 8bec            mov     ebp,esp</div><div class="line">01010073 83ec2c          sub     esp,2Ch</div><div class="line">01010076 894dfc          mov     dword ptr [ebp-4],ecx</div><div class="line">01010079 833d142eaf0000  cmp     dword ptr ds:[0AF2E14h],0</div><div class="line">01010080 7405            je      01010087</div><div class="line">01010082 e832ff0d79      call    mscorwks!JIT_DbgIsJustMyCode (7a0effb9)</div><div class="line">01010087 33d2            xor     edx,edx</div><div class="line">01010089 8955ec          mov     dword ptr [ebp-14h],edx</div><div class="line">0101008c 33d2            xor     edx,edx</div><div class="line">0101008e 8955f0          mov     dword ptr [ebp-10h],edx</div><div class="line">01010091 33d2            xor     edx,edx</div><div class="line">01010093 8955f4          mov     dword ptr [ebp-0Ch],edx</div><div class="line">01010096 33d2            xor     edx,edx</div><div class="line">01010098 8955f8          mov     dword ptr [ebp-8],edx</div><div class="line">0101009b 33d2            xor     edx,edx</div><div class="line">0101009d 8955e8          mov     dword ptr [ebp-18h],edx</div><div class="line">010100a0 90              nop</div><div class="line">010100a1 8b0d30204202    mov     ecx,dword ptr ds:[2422030h] (&quot;Polymorphism01 demo&quot;)</div><div class="line">*** WARNING: Unable to verify checksum for C:\WINDOWS\assembly\NativeImages_v2.0.50727_32\mscorlib\b14359470744c840c59fbe4e58034fd6\mscorlib.ni.dll</div><div class="line">010100a7 e8b0457878      call    mscorlib_ni+0x6d465c (7979465c) (System.Console.WriteLine(System.String), mdToken: 060007c8)</div><div class="line">010100ac 90              nop</div><div class="line">010100ad b99830af00      mov     ecx,0AF3098h (MT: BaseClass)</div><div class="line">010100b2 e8651fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">010100b7 8945e4          mov     dword ptr [ebp-1Ch],eax</div><div class="line">010100ba 8b4de4          mov     ecx,dword ptr [ebp-1Ch]</div><div class="line">010100bd ff15d830af00    call    dword ptr ds:[0AF30D8h] (BaseClass..ctor(), mdToken: 06000005)</div><div class="line">010100c3 8b45e4          mov     eax,dword ptr [ebp-1Ch]</div><div class="line">010100c6 8945f8          mov     dword ptr [ebp-8],eax</div><div class="line">010100c9 b90c31af00      mov     ecx,0AF310Ch (MT: ChlidClass)</div><div class="line">010100ce e8491fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">010100d3 8945e0          mov     dword ptr [ebp-20h],eax</div><div class="line">010100d6 8b4de0          mov     ecx,dword ptr [ebp-20h]</div><div class="line">010100d9 ff154c31af00    call    dword ptr ds:[0AF314Ch] (ChlidClass..ctor(), mdToken: 06000008)</div><div class="line">010100df 8b45e0          mov     eax,dword ptr [ebp-20h]</div><div class="line">010100e2 8945f4          mov     dword ptr [ebp-0Ch],eax</div><div class="line">010100e5 b98831af00      mov     ecx,0AF3188h (MT: BrotherClass)</div><div class="line">010100ea e82d1fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">010100ef 8945dc          mov     dword ptr [ebp-24h],eax</div><div class="line">010100f2 8b4ddc          mov     ecx,dword ptr [ebp-24h]</div><div class="line">010100f5 ff15cc31af00    call    dword ptr ds:[0AF31CCh] (BrotherClass..ctor(), mdToken: 0600000c)</div><div class="line">010100fb 8b45dc          mov     eax,dword ptr [ebp-24h]</div><div class="line">010100fe 8945f0          mov     dword ptr [ebp-10h],eax</div><div class="line">01010101 b90832af00      mov     ecx,0AF3208h (MT: DerivedOfBrotherClass)</div><div class="line">01010106 e8111fadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">0101010b 8945d8          mov     dword ptr [ebp-28h],eax</div><div class="line">0101010e 8b4dd8          mov     ecx,dword ptr [ebp-28h]</div><div class="line">01010111 ff154c32af00    call    dword ptr ds:[0AF324Ch] (DerivedOfBrotherClass..ctor(), mdToken: 06000010)</div><div class="line">01010117 8b45d8          mov     eax,dword ptr [ebp-28h]</div><div class="line">0101011a 8945ec          mov     dword ptr [ebp-14h],eax</div><div class="line">0101011d b90832af00      mov     ecx,0AF3208h (MT: DerivedOfBrotherClass)</div><div class="line">01010122 e8f51eadff      call    00ae201c (JitHelp: CORINFO_HELP_NEWSFAST)</div><div class="line">01010127 8945d4          mov     dword ptr [ebp-2Ch],eax</div><div class="line">0101012a 8b4dd4          mov     ecx,dword ptr [ebp-2Ch]</div><div class="line">0101012d ff154c32af00    call    dword ptr ds:[0AF324Ch] (DerivedOfBrotherClass..ctor(), mdToken: 06000010)</div><div class="line">01010133 8b45d4          mov     eax,dword ptr [ebp-2Ch]</div><div class="line">01010136 8945e8          mov     dword ptr [ebp-18h],eax</div><div class="line">01010139 8b4df8          mov     ecx,dword ptr [ebp-8]</div><div class="line">0101013c 8b01            mov     eax,dword ptr [ecx]</div><div class="line">0101013e ff5038          call    dword ptr [eax+38h]</div><div class="line">01010141 90              nop</div><div class="line">01010142 8b4df4          mov     ecx,dword ptr [ebp-0Ch]</div><div class="line">01010145 8b01            mov     eax,dword ptr [ecx]</div><div class="line">01010147 ff5038          call    dword ptr [eax+38h]</div><div class="line">0101014a 90              nop</div><div class="line">0101014b 8b4df0          mov     ecx,dword ptr [ebp-10h]</div><div class="line">0101014e 8b01            mov     eax,dword ptr [ecx]</div><div class="line">01010150 ff5038          call    dword ptr [eax+38h]</div><div class="line">01010153 90              nop</div><div class="line">01010154 8b4dec          mov     ecx,dword ptr [ebp-14h]</div><div class="line">01010157 8b01            mov     eax,dword ptr [ecx]</div><div class="line">01010159 ff5038          call    dword ptr [eax+38h]</div><div class="line">0101015c 90              nop</div><div class="line">0101015d 8b4dec          mov     ecx,dword ptr [ebp-14h]</div><div class="line">01010160 8b01            mov     eax,dword ptr [ecx]</div><div class="line">01010162 ff503c          call    dword ptr [eax+3Ch]</div><div class="line">01010165 90              nop</div><div class="line">01010166 8b4de8          mov     ecx,dword ptr [ebp-18h]</div><div class="line">01010169 8b01            mov     eax,dword ptr [ecx]</div><div class="line">0101016b ff5040          call    dword ptr [eax+40h]</div><div class="line">0101016e 90              nop</div><div class="line">0101016f e8fc477878      call    mscorlib_ni+0x6d4970 (79794970) (System.Console.ReadLine(), mdToken: 060007ba)</div><div class="line">01010174 90              nop</div><div class="line">01010175 90              nop</div><div class="line">01010176 8be5            mov     esp,ebp</div><div class="line">01010178 5d              pop     ebp</div><div class="line">01010179 c3              ret</div></pre></td></tr></table></figure>
</li>
<li><p>这里最重要的几行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">01010139 8b4df8          mov     ecx,dword ptr [ebp-8]   // 这里是BaseClass实例对象的地址 放到 ecx寄存器,Jit采用类似fastcall的调用协定,前2个不大于4字节的参数用 ecx edx来传递,而实例方法的调用第一个参数是隐含的this指针(托管对象在托管堆上的地址),如果是静态方法就不需要传this pointer了</div><div class="line">0101013c 8b01            mov     eax,dword ptr [ecx]    // 托管堆上的对象(值类型装箱后也是一样)第一个4字节(64位8字节)是对象的方法表地址(MethodTable),这里是把方法表(MethodTable)地址赋给eax寄存器</div><div class="line">0101013e ff5038          call    dword ptr [eax+38h]    // 这里就是实际的方法调用 上面说了 第一个虚方法在方法表的偏移28h位置,前4个是Object里的4个虚方法,所以 VirtualFun1 的入口在方法表地址(MT) + 28h + 4×4字节 也就是偏移38h的位置</div><div class="line">01010141 90              nop</div><div class="line">01010142 8b4df4          mov     ecx,dword ptr [ebp-0Ch]    // 这里是 ChlidClass的对象地址赋给ecx</div><div class="line">01010145 8b01            mov     eax,dword ptr [ecx]    // 同样ChlidClass的方法表地址赋给eax</div><div class="line">01010147 ff5038          call    dword ptr [eax+38h]    // 调用ChlidClass方法表偏移38h的方法,也是VirtualFun1 方法</div><div class="line">0101014a 90              nop</div><div class="line">0101014b 8b4df0          mov     ecx,dword ptr [ebp-10h]    // BrotherClass的对象地址赋给ecx</div><div class="line">0101014e 8b01            mov     eax,dword ptr [ecx]    // BrotherClass方法表地址赋给eax</div><div class="line">01010150 ff5038          call    dword ptr [eax+38h]    // 调用BrotherClass方法表偏移38h的方法,也是VirtualFun1 方法</div><div class="line">01010153 90              nop</div><div class="line">01010154 8b4dec          mov     ecx,dword ptr [ebp-14h]    // DerivedOfBrotherClass的对象地址赋给ecx</div><div class="line">01010157 8b01            mov     eax,dword ptr [ecx]    // DerivedOfBrotherClass方法表地址赋给eax</div><div class="line">01010159 ff5038          call    dword ptr [eax+38h]     // 调用DerivedOfBrotherClass方法表偏移38h的方法,也是VirtualFun1 方法</div><div class="line">0101015c 90              nop</div><div class="line">0101015d 8b4dec          mov     ecx,dword ptr [ebp-14h]    // 还是DerivedOfBrotherClass对象地址</div><div class="line">01010160 8b01            mov     eax,dword ptr [ecx]    // DerivedOfBrotherClass的方法表赋给eax</div><div class="line">01010162 ff503c          call    dword ptr [eax+3Ch]    // 这次偏移不一样了,第6个方法 VirtualFun2 (28h+5×4字节)</div><div class="line">01010165 90              nop</div><div class="line">01010166 8b4de8          mov     ecx,dword ptr [ebp-18h]    // 还是DerivedOfBrotherClass对象地址</div><div class="line">01010169 8b01            mov     eax,dword ptr [ecx]    // DerivedOfBrotherClass的方法表赋给eax</div><div class="line">0101016b ff5040          call    dword ptr [eax+40h]    // 这次偏移又不一样了,第7个方法 VirtualFun3 (28h+6×4字节)</div></pre></td></tr></table></figure>
</li>
<li><p><strong>可以看到 继承多态在CLR运行时的实现是通过方法表的偏移 间接调用的,而方法表内继承虚方法的构建顺序是先父类再子类,由于.NET是单一继承,这样就确保了在同一家族的同一虚方法的偏移量是一样的.</strong></p>
</li>
<li><p>接下来用Framework 4.0 编译下源码,4.0 和2.0相比 在实现上多了一层间接寻址,但思路是一样的</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">%windir%\Microsoft.NET\Framework\v4.0.30319\csc.exe /debug /target:exe /out:e:\temp\Polymorphism01_4.0.exe e:\temp\Polymorphism01.cs</div><div class="line">pause</div></pre></td></tr></table></figure>
<ul>
<li><p>运行 Polymorphism01_4.0.exe </p>
</li>
<li><p>启动windbg 附加进程 加载SOS (这里要加载对于4.0的sos.dll) </p>
</li>
<li>直接查找Main方法:<br><code>!Name2EE Polymorphism01_4.0.exe Program.Main</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0:004&gt; !Name2EE Polymorphism01_4.0.exe Program.Main</div><div class="line">Module:      00b32ea4</div><div class="line">Assembly:    Polymorphism01_4.0.exe</div><div class="line">Token:       06000001</div><div class="line">MethodDesc:  00b33838</div><div class="line">Name:        Program.Main(System.String[])</div><div class="line">JITTED Code Address: 033a0070</div></pre></td></tr></table></figure>
<ul>
<li><p>看Main方法的区别:<code>!u 033a0070</code><br>这里只截取最重要的一段,调用构造器和其他的部分都先忽略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">e:\temp\Polymorphism01.cs @ 16:</div><div class="line">033a0139 8b4df8          mov     ecx,dword ptr [ebp-8]  // 这个还是一样BaseClass对象的地址赋给ecx</div><div class="line">033a013c 8b01            mov     eax,dword ptr [ecx]    // 还是对象的第一个4字节是方法表地址 赋给eax</div><div class="line">033a013e 8b4028          mov     eax,dword ptr [eax+28h]    // 这里是和2.0的区别 所有继承的虚方法的起始地址保存在方法表偏移28h的位置,也就是偏移量不是从方法表地址开始算了</div><div class="line">033a0141 ff5010          call    dword ptr [eax+10h]    // 这里的方式一样的 eax是虚方法的起始位置了,前4个是Object的4个虚方法,偏移10h是第5个方法 VirtualFun1</div><div class="line">033a0144 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 17:</div><div class="line">033a0145 8b4df4          mov     ecx,dword ptr [ebp-0Ch]    // ChlidClass对象地址赋给ecx</div><div class="line">033a0148 8b01            mov     eax,dword ptr [ecx]    // ChlidClass方法表地址赋给eax</div><div class="line">033a014a 8b4028          mov     eax,dword ptr [eax+28h]    // 虚表入口地址赋给eax</div><div class="line">033a014d ff5010          call    dword ptr [eax+10h]    //还是偏移到第5个方法 VirtualFun1</div><div class="line">033a0150 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 18:</div><div class="line">033a0151 8b4df0          mov     ecx,dword ptr [ebp-10h]    // BrotherClass对象地址赋给ecx</div><div class="line">033a0154 8b01            mov     eax,dword ptr [ecx]     // BrotherClass方法表地址赋给eax</div><div class="line">033a0156 8b4028          mov     eax,dword ptr [eax+28h]    // 虚表入口地址赋给eax</div><div class="line">033a0159 ff5010          call    dword ptr [eax+10h]    //还是偏移到第5个方法 VirtualFun1</div><div class="line">033a015c 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 19:</div><div class="line">033a015d 8b4dec          mov     ecx,dword ptr [ebp-14h]    // DerivedOfBrotherClass对象地址赋给ecx</div><div class="line">033a0160 8b01            mov     eax,dword ptr [ecx]    // DerivedOfBrotherClass方法表地址赋给eax</div><div class="line">033a0162 8b4028          mov     eax,dword ptr [eax+28h]    // 虚表入口地址赋给eax</div><div class="line">033a0165 ff5010          call    dword ptr [eax+10h]    //还是偏移到第5个方法 VirtualFun1</div><div class="line">033a0168 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 20:</div><div class="line">033a0169 8b4dec          mov     ecx,dword ptr [ebp-14h]    // 上面同一个对象</div><div class="line">033a016c 8b01            mov     eax,dword ptr [ecx]</div><div class="line">033a016e 8b4028          mov     eax,dword ptr [eax+28h]</div><div class="line">033a0171 ff5014          call    dword ptr [eax+14h]    // 这里比上面的调用多偏移了4个字节 也就是第6个方法 VirtualFun2</div><div class="line">033a0174 90              nop</div><div class="line"></div><div class="line">e:\temp\Polymorphism01.cs @ 21:</div><div class="line">033a0175 8b4de8          mov     ecx,dword ptr [ebp-18h]    // 和上面不是同一个对象地址,但是是实例化同样类型的对象</div><div class="line">033a0178 8b01            mov     eax,dword ptr [ecx]</div><div class="line">033a017a 8b4028          mov     eax,dword ptr [eax+28h]</div><div class="line">033a017d ff5018          call    dword ptr [eax+18h]     // 这里比上面的调用再多偏移了4个字节 也就是第7个方法 VirtualFun3</div><div class="line">033a0180 90              nop</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p><strong>.NET 4.0 比2.0 多了一次间接寻址,就是先偏移到虚表的入口,再从这个入口开始偏移到相应的方法,这样的好处(个人觉得)虚表的存储位置可以更灵活 如果方法表(MT)包含多个可变长结构也没问题 只要入口地址保存在偏移28h的位置即可</strong></p>
</li>
</ul>
<blockquote>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><p><a href="https://www.microsoft.com/china/MSDN/library/netFramework/netframework/JITCompiler.mspx?mfr=true" target="_blank" rel="external">https://www.microsoft.com/china/MSDN/library/netFramework/netframework/JITCompiler.mspx?mfr=true</a><br><a href="http://www.codeproject.com/Articles/20481/NET-Type-Internals-From-a-Microsoft-CLR-Perspecti" target="_blank" rel="external">http://www.codeproject.com/Articles/20481/NET-Type-Internals-From-a-Microsoft-CLR-Perspecti</a><br><a href="http://blogs.microsoft.co.il/sasha/2012/03/15/virtual-method-dispatch-and-object-layout-changes-in-clr-40/" target="_blank" rel="external">http://blogs.microsoft.co.il/sasha/2012/03/15/virtual-method-dispatch-and-object-layout-changes-in-clr-40/</a><br><a href="http://www.cnblogs.com/BlueTzar/articles/884694.html" target="_blank" rel="external">http://www.cnblogs.com/BlueTzar/articles/884694.html</a></p>
</blockquote>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/CLR/inheritance-polymorphism/" class="archive-article-date">
  	<time datetime="2016-10-19T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-10-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET/">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CLR/">CLR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JIT/">JIT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RunTime/">RunTime</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/CLR/">CLR</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-method-descriptor" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/CLR/method-descriptor/">CLR运行时细节 - Method Descriptor</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- # CLR运行时细节 - Method Descriptor -->
<h2 id="方法描述符-MethodDesc"><a href="#方法描述符-MethodDesc" class="headerlink" title="方法描述符:MethodDesc"></a>方法描述符:MethodDesc</h2><ul>
<li>运行时用来描述类型的托管方法,它保存在方法描述桶(MethodDescChunk)内;</li>
<li>方法描述符保存了方法在运行时的一些重要信息:<ul>
<li>是否JIT编译;</li>
<li>是否有方法表槽(决定了方法入口是跟在方法描述符(MethodDesc)后还是在方法表(MethodTable)后面);</li>
<li>距离MethodDescChunk的索引(chunkIndex);</li>
<li>Token的末位(这个在编译期确定了);</li>
<li>方法的一些标识比如是否静态 非内联等;</li>
<li>方法表槽(slot number);</li>
<li>以及最重要的方法入口(entrypoint);</li>
</ul>
</li>
</ul>
<blockquote>
<p>官方的描述:<br>MethodDesc (method descriptor) is the internal representation of a managed method. It serves several purposes:  </p>
<ul>
<li>Provides a unique method handle, usable throughout the runtime. For normal methods, the MethodDesc is a unique handle for a triplet.</li>
<li>Caches frequently used information that is expensive to compute from metadata (e.g. whether the method is static).</li>
<li>Captures the runtime state of the method (e.g. whether the code has been generated for the method already).</li>
<li>Owns the entry point of the method.</li>
</ul>
</blockquote>
<p><strong>先看下Demo C# MethodDesc.cs 代码:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Runtime.CompilerServices;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Program</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MethodDesc demo"</span>);</div><div class="line">		Console.ReadLine();</div><div class="line"></div><div class="line">		MDChlidClass cc = <span class="keyword">new</span> MDChlidClass();</div><div class="line">		cc.VirtualFun1();</div><div class="line">		cc.VirtualFun2();</div><div class="line">		cc.IFun1();</div><div class="line">		cc.IFun2();</div><div class="line">		cc.InstanceFun1();</div><div class="line">		cc.InstanceFun2();</div><div class="line">		MDChlidClass.StaticFun1();</div><div class="line"></div><div class="line">		Console.ReadLine();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> MDBaseClass</div><div class="line">&#123;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDBaseClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDBaseClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> MDChlidClass : MDBaseClass, IFoo</div><div class="line">&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> TempInt = <span class="number">0</span>;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDChlidClass VirtualFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> override <span class="keyword">void</span> <span class="title">VirtualFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDChlidClass VirtualFun2"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">IFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDChlidClass IFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">IFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDChlidClass IFun2"</span>);</div><div class="line">	&#125;</div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InstanceFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDChlidClass InstanceFun1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InstanceFun2</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDChlidClass InstanceFun2"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	[MethodImpl(MethodImplOptions.NoInlining)]</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticFun1</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		Console.WriteLine(<span class="string">"MDChlidClass StaticFun1"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> interface IFoo</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">IFun1</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">IFun2</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编译代码:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">%windir%\Microsoft.NET\Framework\v2.0.50727\csc.exe /debug /target:exe /out:e:\temp\MethodDesc_2.0.exe e:\temp\MethodDesc.cs</div><div class="line">pause</div></pre></td></tr></table></figure>
<ul>
<li><p>运行 MethodDesc_2.0.exe </p>
</li>
<li><p>启动windbg 加载SOS </p>
</li>
<li><p>查找对应的模块：<br><code>!Name2EE *!MethodDesc_2.0.exe</code></p>
</li>
</ul>
<p><img src="/img/01MD/01.png" alt="" title="Name2EE Module"></p>
<ul>
<li>根据模块查找方法表:<br><code>!DumpModule -mt 00af2c5c</code></li>
</ul>
<p><img src="/img/01MD/02.png" alt="" title="Module MethodTable"></p>
<ul>
<li>通过MDChlidClass方法表地址查看其EEClass 查找方法描述桶在EEClass偏移40h的位置(64位的话偏移60h 因为标记位使用不变 所有地址类型由4字节变成8字节):</li>
</ul>
<p><code>!DumpMT -md 00af31e4</code></p>
<p><img src="/img/01MD/03.png" alt="" title="MethodTable EEClass MethodDescChunk"></p>
<ul>
<li>通过方法桶的地址<code>00af3180</code>观察其下方法描述符：</li>
</ul>
<p><img src="/img/01MD/04.png" alt="" title="MethodDescChunk MethodDesc"></p>
<ul>
<li>可以看到方法描述桶的第一个4字节(64位8字节)是方法表(MethodTable)的地址<br>可以看到MDChlidClass的方法描述符(MD)</li>
<li><strong>VirtualFun1</strong> 方法描述符地址:<code>00af3190</code> 其内容:<code>00000008 20000004</code> 第一个<code>00</code>代表方法入口在方法表(MT)后面以及还没jit编译,第二个<code>00</code>代表距方法描述桶(MethodDescChunk)的索引(便于找到桶的起始位置),后面的<code>0008</code>是方法的token末位 在编译成IL时确定,可以通过ildasm查看 MethodDesc_2.0.exe 文件,这个token是在编译期程序集内自增的,也就是在运行时并不是唯一的接下来的<code>2000</code>代表方法非内联,<code>0004</code>代表方法表槽slot number 也就是方法入口(entrypoint)在方法表(MT)后的索引(索引从0开始 一般来说前4个方法都是从Object继承下来的4个虚方法 除了接口类型),方法入口:00afc075</li>
</ul>
<p><img src="/img/01MD/05.png" alt="" title="ildasm token"></p>
<ul>
<li><strong>VirtualFun2</strong> 方法描述符地址:<code>00af3198</code> 其内容:<code>00020009 20000005</code> 依旧是没jit编译,方法入口在方法表后,token:0009,非内联,slot number:0005,方法入口:00afc079</li>
<li><strong>IFun1</strong> 方法描述符地址:<code>00af31a0</code> 其内容:<code>0004000a 20000006</code> 依旧是没jit编译,方法入口在方法表后,token:000a,非内联,slot number:0006,方法入口:00afc07d</li>
<li><strong>IFun2</strong> 方法描述符地址:<code>00af31a8</code> 其内容:<code>0006000b 20000007</code> 依旧是没jit编译,方法入口在方法表后,token:000b,非内联,slot number:0007,方法入口:00afc081</li>
<li><strong>InstanceFun1</strong> 方法描述符地址:<code>00af31b0</code> 其内容:<code>4008000c 2000000a 00afc085</code> ‘40’这位(bit)代表方法入口(slot)是跟在方法描述符(MD)后面的并非在方法表(MT)后面,依旧是没jit编译,方法入口在方法表后,token:000c,非内联,slot number:000a(这里的slot number依然有值,但值是大于等方法表的slot长度的),方法入口:00afc085 </li>
<li><strong>InstanceFun2</strong> 方法描述符地址:<code>00af31bc</code> 其内容:<code>400b000d 2000000b 00afc089</code> 依旧是没jit编译,方法入口在方法描述符(MD)后,token:000d,非内联,slot number:000b,方法入口:00afc089</li>
<li><strong>StaticFun1</strong> 方法描述符地址:<code>00af31c8</code> 其内容:<code>400b000e 2020000c 00afc08d</code> 依旧是没jit编译,方法入口在方法描述符(MD)后,token:000e,<code>2020</code>非内联 并且静态,slot number:000c,方法入口:00afc08d</li>
<li><strong>.ctor</strong> 实例构造方法 方法描述符地址:<code>00af31d4</code> 其内容:<code>0011000f 00000008</code> 依旧是没jit编译,方法入口在方法表后,token:000f,slot number:0008,方法入口:00afc091</li>
<li><strong>.cctor</strong> 静态构造方法 方法描述符地址:<code>00af31dc</code> 其内容:<code>00130010 00200009</code> 依旧是没jit编译,方法入口在方法表后,token:0010,静态的:0020,slot number:0009,方法入口:00afc095</li>
</ul>
<p><strong>可以看到所有的虚方法(继承或者实现接口)以及构造器方法(实例或者静态)的方法入口(slot)都是在方法表后面的,而其他实例方法和静态方法的方法入口(slot)是跟在方法描述符(MD)后面的</strong></p>
<blockquote>
<p><strong>这里引用下CLR文档的一段:</strong><br>Each MethodDesc has a slot, which contains the entry point of the method. The slot and entry point must exist for all methods, even the ones that never run like abstract methods. There are multiple places in the runtime that depend on the 1:1 mapping between entry points and MethodDescs, making this relationship an invariant.<br>The slot is either in MethodTable or in MethodDesc itself. The location of the slot is determined by mdcHasNonVtableSlot bit on MethodDesc.<br>The slot is stored in MethodTable for methods that require efficient lookup via slot index, e.g. virtual methods or methods on generic types. The MethodDesc contains the slot index to allow fast lookup of the entry point in this case.</p>
</blockquote>
<p>接下来让 MethodDesc_2.0.exe 继续执行,并回车跳过第一个<code>ReadLine()</code>,再中断到调试器,观察MDChlidClass的方法表<code>00af31e4</code>(MT)和其方法描述桶<code>00af3180</code>(MDC)</p>
<p><img src="/img/01MD/06.png" alt="" title="Jit MT MD"></p>
<p>可以看到所有Jit编译过的方法,其方法描述符的 00h或者40h 会 逻辑 <strong>或</strong> 31h,都是按位的,其中30h是安全描述符先忽略,01h代表是否Jit编译过,同时所有Jit编译过的方法其方法入口(entrypoint)会更新</p>
<p>更新安全描述符:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">0:000&gt; uf mscorwks!MethodDesc::SetCriticalTransparentInfo</div><div class="line">mscorwks!MethodDesc::SetCriticalTransparentInfo:</div><div class="line">79e90595 55              push    ebp</div><div class="line">79e90596 8bec            mov     ebp,esp</div><div class="line">79e90598 837d0c00        cmp     dword ptr [ebp+0Ch],0</div><div class="line">79e9059c 0f84a4e01100    je      mscorwks!MethodDesc::SetCriticalTransparentInfo+0xe (79fae646)</div><div class="line"></div><div class="line">mscorwks!MethodDesc::SetCriticalTransparentInfo+0x9:</div><div class="line">79e905a2 6a30            push    30h</div><div class="line">79e905a4 58              pop     eax</div><div class="line"></div><div class="line">mscorwks!MethodDesc::SetCriticalTransparentInfo+0x1b:</div><div class="line">79e905a5 6a01            push    1</div><div class="line">79e905a7 50              push    eax</div><div class="line">79e905a8 e8caffffff      call    mscorwks!MethodDesc::InterlockedUpdateFlags2 (79e90577)</div><div class="line">79e905ad 5d              pop     ebp</div><div class="line">79e905ae c20800          ret     8</div><div class="line"></div><div class="line">mscorwks!MethodDesc::SetCriticalTransparentInfo+0xe:</div><div class="line">79fae646 8b4508          mov     eax,dword ptr [ebp+8]</div><div class="line">79fae649 f7d8            neg     eax</div><div class="line">79fae64b 1bc0            sbb     eax,eax</div><div class="line">79fae64d 83e010          and     eax,10h</div><div class="line">79fae650 83c010          add     eax,10h</div><div class="line">79fae653 e94d1feeff      jmp     mscorwks!MethodDesc::SetCriticalTransparentInfo+0x1b (79e905a5)</div></pre></td></tr></table></figure></p>
<p>先更新方法入口,再更新是否Jit编译标记位:<br><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/method.cpp#L5099" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/src/vm/method.cpp#L5099</a><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">BOOL MethodDesc::SetStableEntryPointInterlocked(PCODE addr)</div><div class="line">&#123;</div><div class="line">    CONTRACTL &#123;</div><div class="line">        THROWS;</div><div class="line">        GC_NOTRIGGER;</div><div class="line">    &#125; CONTRACTL_END;</div><div class="line"></div><div class="line">    _ASSERTE(!HasPrecode());</div><div class="line"></div><div class="line">    PCODE pExpected = GetTemporaryEntryPoint();</div><div class="line">    PTR_PCODE pSlot = GetAddrOfSlot();</div><div class="line">    EnsureWritablePages(pSlot);</div><div class="line"></div><div class="line">    BOOL fResult = FastInterlockCompareExchangePointer(pSlot, addr, pExpected) == pExpected;</div><div class="line"></div><div class="line">    InterlockedUpdateFlags2(enum_flag2_HasStableEntryPoint, TRUE);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> fResult;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">0:000&gt; uf mscorwks!MethodDesc::SetStableEntryPointInterlocked</div><div class="line">mscorwks!MethodDesc::SetStableEntryPointInterlocked:</div><div class="line">79ed9a27 55              push    ebp</div><div class="line">79ed9a28 8bec            mov     ebp,esp</div><div class="line">79ed9a2a 53              push    ebx</div><div class="line">79ed9a2b 56              push    esi</div><div class="line">79ed9a2c 57              push    edi</div><div class="line">79ed9a2d 8bf9            mov     edi,ecx</div><div class="line">79ed9a2f e8b96afbff      call    mscorwks!MethodDesc::GetTemporaryEntryPoint (79e904ed)</div><div class="line">79ed9a34 8bcf            mov     ecx,edi</div><div class="line">79ed9a36 8bd8            mov     ebx,eax</div><div class="line">79ed9a38 e8156bfbff      call    mscorwks!MethodDesc::GetAddrOfSlot (79e90552)</div><div class="line">79ed9a3d 8b5508          mov     edx,dword ptr [ebp+8]</div><div class="line">79ed9a40 53              push    ebx</div><div class="line">79ed9a41 8bc8            mov     ecx,eax</div><div class="line">79ed9a43 ff15d0c33c7a    call    dword ptr [mscorwks!FastInterlockCompareExchange (7a3cc3d0)]</div><div class="line">79ed9a49 8bf0            mov     esi,eax</div><div class="line">79ed9a4b 2bf3            sub     esi,ebx</div><div class="line">79ed9a4d f7de            neg     esi</div><div class="line">79ed9a4f 1bf6            sbb     esi,esi</div><div class="line">79ed9a51 46              inc     esi</div><div class="line">79ed9a52 ba00000001      mov     edx,1000000h</div><div class="line">79ed9a57 8bcf            mov     ecx,edi</div><div class="line">79ed9a59 ff1574c23c7a    call    dword ptr [mscorwks!FastInterlockOr (7a3cc274)]</div><div class="line">79ed9a5f 5f              pop     edi</div><div class="line">79ed9a60 8bc6            mov     eax,esi</div><div class="line">79ed9a62 5e              pop     esi</div><div class="line">79ed9a63 5b              pop     ebx</div><div class="line">79ed9a64 5d              pop     ebp</div><div class="line">79ed9a65 c20400          ret     4</div></pre></td></tr></table></figure>
<ul>
<li>可以通过 <code>DumpMD</code> SOS扩展命令观察方法描述符:</li>
</ul>
<p><img src="/img/01MD/07.png" alt="" title="Jit MT MD"></p>
<p>为毛要研究方法描述符这个东西?<br>方法描述符在CLR运行时作为方法的最基础服务,继承多态在运行时的实现依赖方法描述符,接口多态的运行时DispatchToken以及实现也依赖.</p>
<blockquote>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><p><a href="https://github.com/dotnet/coreclr/blob/master/Documentation/botr/method-descriptor.md" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/Documentation/botr/method-descriptor.md</a><br><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/methodtablebuilder.cpp" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/src/vm/methodtablebuilder.cpp</a><br><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/method.hpp" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/src/vm/method.hpp</a><br><a href="http://blogs.microsoft.co.il/sasha/2009/09/27/how-are-methods-compiled-just-in-time-and-only-then/" target="_blank" rel="external">http://blogs.microsoft.co.il/sasha/2009/09/27/how-are-methods-compiled-just-in-time-and-only-then/</a></p>
</blockquote>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/CLR/method-descriptor/" class="archive-article-date">
  	<time datetime="2016-10-16T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-10-17</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET/">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CLR/">CLR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JIT/">JIT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RunTime/">RunTime</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/CLR/">CLR</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 chengl
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?f685bce203ffb2e96d5a6473d1252d95";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/NET/" style="font-size: 16.67px;">.NET</a> <a href="/tags/NET-Core/" style="font-size: 13.33px;">.NET Core</a> <a href="/tags/CLR/" style="font-size: 16.67px;">CLR</a> <a href="/tags/Debug/" style="font-size: 10px;">Debug</a> <a href="/tags/JIT/" style="font-size: 16.67px;">JIT</a> <a href="/tags/LLDB/" style="font-size: 10px;">LLDB</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/RunTime/" style="font-size: 20px;">RunTime</a>
    			</div>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">espider@126.com</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>